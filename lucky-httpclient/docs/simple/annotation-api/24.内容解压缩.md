## ğŸ¦† å†…å®¹è§£å‹ç¼©

HTTP å†…å®¹å‹ç¼©æ˜¯æŒ‡åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´é€šè¿‡å‹ç¼©æ•°æ®æ¥å‡å°‘ä¼ è¾“çš„æ•°æ®é‡ï¼Œæé«˜ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡å’Œå“åº”é€Ÿåº¦çš„æŠ€æœ¯ã€‚HTTP å†…å®¹å‹ç¼©é€šå¸¸ç”¨äºä¼ è¾“ HTMLã€CSSã€JavaScript å’Œå…¶ä»–æ–‡æœ¬æ ¼å¼çš„æ•°æ®ã€‚

**å¸¸è§çš„ HTTP å†…å®¹å‹ç¼©ç®—æ³•åŒ…æ‹¬ï¼š**

- `Gzip`ï¼šæœ€å¸¸ç”¨çš„å‹ç¼©ç®—æ³•ä¹‹ä¸€ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°å‡å°‘æ–‡æœ¬æ•°æ®çš„å¤§å°ã€‚`Gzip` æ˜¯åŸºäº `DEFLATE` ç®—æ³•å®ç°çš„ã€‚
- `Brotli`ï¼šç”± Google å¼€å‘çš„å‹ç¼©ç®—æ³•ï¼Œé€šå¸¸æ¯” `Gzip` æä¾›æ›´å¥½çš„å‹ç¼©æ¯”ã€‚`Brotli` åœ¨ç°ä»£æµè§ˆå™¨å’Œ HTTP æœåŠ¡å™¨ä¸­å¾—åˆ°äº†å¹¿æ³›çš„æ”¯æŒã€‚
- `Deflate`ï¼šå¦ä¸€ç§å‹ç¼©ç®—æ³•ï¼ŒåŸºäº `LZ77 `å’Œ`å“ˆå¤«æ›¼ç¼–ç `ã€‚å°½ç®¡æ¯”` Gzip` æ›´å°‘ä½¿ç”¨ï¼Œä½†ä»ç„¶æ”¯æŒã€‚
- `Zstandard (zstd)`ï¼šç”± Facebook å¼€å‘çš„å‹ç¼©ç®—æ³•ï¼Œå‹ç¼©é€Ÿåº¦è¾ƒå¿«ï¼Œå‹ç¼©æ¯”ä¼˜äº Gzipã€‚

**å¦‚ä½•å·¥ä½œ**  
1. **è¯·æ±‚å‹ç¼©**ï¼šå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯ï¼‰å‘é€è¯·æ±‚å¤´æ—¶ï¼Œä¼šåœ¨ `Accept-Encoding` å­—æ®µä¸­æŒ‡å®šæ”¯æŒçš„å‹ç¼©ç®—æ³•ï¼ˆå¦‚ `gzip`, `deflate`, `br` ç­‰ï¼‰ã€‚ ä¾‹å¦‚ï¼š
    ```http request
    Accept-Encoding: gzip, deflate, br
    ```
2. **å“åº”å‹ç¼©**ï¼šæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚å¤´ä¸­ `Accept-Encoding` å­—æ®µï¼Œé€‰æ‹©æ”¯æŒçš„å‹ç¼©ç®—æ³•ï¼Œå‹ç¼©å“åº”æ•°æ®å¹¶åœ¨ `Content-Encoding` å­—æ®µä¸­è¿”å›æ‰€ä½¿ç”¨çš„å‹ç¼©æ ¼å¼ã€‚ä¾‹å¦‚ï¼š
    ```http request
    Content-Encoding: gzip
    ```
3. **å®¢æˆ·ç«¯è§£å‹ç¼©**ï¼šå®¢æˆ·ç«¯æ ¹æ® `Content-Encoding` å­—æ®µçš„å€¼è‡ªåŠ¨è§£å‹ç¼©å“åº”ä½“ã€‚å¦‚æœæœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ `Gzip` æˆ– `Brotli` ç­‰å¸¸è§å‹ç¼©æ ¼å¼ï¼Œç°ä»£æµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†ã€‚

**ä¼˜ç‚¹**   
- **å‡å°‘ä¼ è¾“æ•°æ®é‡**ï¼šå‹ç¼©å¯ä»¥å¤§å¤§å‡å°‘å“åº”æ•°æ®çš„å¤§å°ï¼Œä»è€ŒèŠ‚çœå¸¦å®½ï¼Œå°¤å…¶æ˜¯å¯¹äºæ–‡æœ¬æ•°æ®ã€‚
- **æé«˜åŠ è½½é€Ÿåº¦**ï¼šé€šè¿‡å‡å°‘ä¼ è¾“æ—¶é—´ï¼Œå‹ç¼©å¯ä»¥æ˜¾è‘—åŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ã€‚
- **å‡è½»æœåŠ¡å™¨è´Ÿæ‹…**ï¼šè™½ç„¶å‹ç¼©ä¼šå¢åŠ ä¸€å®šçš„ CPU è´Ÿè½½ï¼Œä½†é€šå¸¸å¸¦æ¥çš„å¸¦å®½èŠ‚çœå’ŒåŠ è½½æ—¶é—´ä¼˜åŒ–è¶…è¿‡äº†å‹ç¼©å¸¦æ¥çš„å¼€é”€

**ç¼ºç‚¹**   
- **CPU è´Ÿè½½**ï¼šå‹ç¼©å’Œè§£å‹ç¼©è¿‡ç¨‹éœ€è¦é¢å¤–çš„ CPU èµ„æºï¼Œç‰¹åˆ«æ˜¯å½“å‹ç¼©æ¯”å¾ˆé«˜æ—¶ã€‚

---
### #ä½¿ç”¨`@GzipCompress`æ³¨è§£å¼€å¯`Gzip`æ ¼å¼å†…å®¹å‹ç¼©åŠŸèƒ½

```java
// æ ‡æ³¨åœ¨ç±»ä¸Šè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•å‡å¼€å¯åŸºäºGzipçš„å†…å®¹å‹ç¼©åŠŸèƒ½ï¼Œå¯¹äºä¸éœ€è¦å†…å®¹å‹ç¼©åŠŸèƒ½çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å¼€å…³é—­æ­¤åŠŸèƒ½
@GzipCompress
@DomainName("http://localhost:8080/")
public interface GzipCompressDemoApi {

    /*
        gzip();
        
        --> 
        
        GET http://localhost:8080/compress/gzip
        User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
        Accept-Encoding: gzip    
     */
    @GzipCompress
    @Get("compress/gzip")
    File gzip();

    /*
        ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å…³é—­å†…å®¹å‹ç¼©åŠŸèƒ½    
    */
    @ContentCompressProhibition
    @Get("compress/notGzip")
    File notGzip();
}
```

---
### #ä½¿ç”¨`@DeflateCompress`æ³¨è§£å¼€å¯`Deflate`æ ¼å¼å†…å®¹å‹ç¼©åŠŸèƒ½

```java
// æ ‡æ³¨åœ¨ç±»ä¸Šè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•å‡å¼€å¯åŸºäºDeflateçš„å†…å®¹å‹ç¼©åŠŸèƒ½ï¼Œå¯¹äºä¸éœ€è¦å†…å®¹å‹ç¼©åŠŸèƒ½çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å¼€å…³é—­æ­¤åŠŸèƒ½
@DeflateCompress
@DomainName("http://localhost:8080/")
public interface DeflateCompressDemoApi {

    /*
        deflate();
        
        --> 
        
        GET http://localhost:8080/compress/deflate
        User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
        Accept-Encoding: deflate    
     */
    @DeflateCompress
    @Get("compress/deflate")
    File deflate();

    /*
        ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å…³é—­å†…å®¹å‹ç¼©åŠŸèƒ½    
    */
    @ContentCompressProhibition
    @Get("compress/notDeflate")
    File notDeflate();
}
```
--- 
### #ä½¿ç”¨`@BrotliCompress`æ³¨è§£å¼€å¯`Brotli`æ ¼å¼å†…å®¹å‹ç¼©åŠŸèƒ½

> æ³¨æ„ï¼šä½¿ç”¨è¯¥å‹ç¼©ç®—æ³•æ—¶éœ€è¦å¯¼å…¥`brotli`ç›¸å…³çš„ä¾èµ–
````xml
 <dependency>
     <groupId>org.brotli</groupId>
     <artifactId>dec</artifactId>
     <version>${version}</version>
 </dependency>
````

```java
// æ ‡æ³¨åœ¨ç±»ä¸Šè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•å‡å¼€å¯åŸºäºBrotliçš„å†…å®¹å‹ç¼©åŠŸèƒ½ï¼Œå¯¹äºä¸éœ€è¦å†…å®¹å‹ç¼©åŠŸèƒ½çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å¼€å…³é—­æ­¤åŠŸèƒ½
@BrotliCompress
@DomainName("http://localhost:8080/")
public interface BrotliCompressDemoApi {

    /*
        brotli();
        
        --> 
        
        GET http://localhost:8080/compress/brotli
        User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
        Accept-Encoding: br    
     */
    @BrotliCompress
    @Get("compress/brotli")
    File brotli();


    /*
        ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å…³é—­å†…å®¹å‹ç¼©åŠŸèƒ½    
    */
    @ContentCompressProhibition
    @Get("compress/notBrotli")
    File notBrotli();
}
```

---
### #ä½¿ç”¨`@ZstdCompress`æ³¨è§£å¼€å¯`Zstandard`æ ¼å¼å†…å®¹å‹ç¼©åŠŸèƒ½

> æ³¨æ„ï¼šä½¿ç”¨è¯¥å‹ç¼©ç®—æ³•æ—¶éœ€è¦å¯¼å…¥`Zstandard`ç›¸å…³çš„ä¾èµ–
````xml
<dependency>
  <groupId>com.github.luben</groupId>
  <artifactId>zstd-jni</artifactId>
  <version>${version}</version>
</dependency>
````

```java
// æ ‡æ³¨åœ¨ç±»ä¸Šè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•å‡å¼€å¯åŸºäºZstandardçš„å†…å®¹å‹ç¼©åŠŸèƒ½ï¼Œå¯¹äºä¸éœ€è¦å†…å®¹å‹ç¼©åŠŸèƒ½çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å¼€å…³é—­æ­¤åŠŸèƒ½
@ZstdCompress
@DomainName("http://localhost:8080/")
public interface ZstandardCompressDemoApi {

    /*
        zstd();
        
        --> 
        
        GET http://localhost:8080/compress/zstandard 
        User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
        Accept-Encoding: zstd    
     */
    @ZstdCompress
    @Get("compress/zstd")
    File zstd();


    /*
        ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å…³é—­å†…å®¹å‹ç¼©åŠŸèƒ½    
     */
    @ContentCompressProhibition
    @Get("compress/notZstd")
    File notZstd();
}
```

---
### #ä½¿ç”¨`@ContentCompress`æ³¨è§£è‡ªå®šä¹‰æ”¯æŒçš„å‹ç¼©æ ¼å¼

> æ³¨ï¼šå¦‚æœéœ€è¦æ”¯æŒ`Brotli`å’Œ`Zstandard`å‹ç¼©æ ¼å¼éœ€è¦å¯¼å…¥ç›¸åº”çš„ä¾èµ–

```java
// æ ‡æ³¨åœ¨ç±»ä¸Šè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•å‡æ”¯æŒè¯¥è‡ªå®šä¹‰æ ¼å¼çš„å†…å®¹å‹ç¼©åŠŸèƒ½ï¼Œå¯¹äºä¸éœ€è¦å†…å®¹å‹ç¼©åŠŸèƒ½çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å¼€å…³é—­æ­¤åŠŸèƒ½
@ContentCompress
@DomainName("http://localhost:8080/")
public interface CustomCompressDemoApi {

    /*
        custom();
        
        --> 
        
        GET http://localhost:8080/compress/custom 
        User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
        Accept-Encoding: gzip, deflate, br, zstd    
     */
    @ContentCompress("gzip, deflate, br, zstd")
    @Get("compress/custom")
    File custom();

    /*
        ä½¿ç”¨@ContentCompressProhibitionæ³¨è§£å…³é—­å†…å®¹å‹ç¼©åŠŸèƒ½    
    */
    @ContentCompressProhibition
    @Get("compress/notCustom")
    File notCustom();
}
```

---
### #å¼€å¯å…¨å±€å†…å®¹å‹ç¼©åŠŸèƒ½
1. åŸç”Ÿç¯å¢ƒ
    ```java
    // æ·»åŠ Brotliè§£ç å™¨
    AbstractSaveResultResponseProcessor.addContentEncodingConvertor(new BrotliContentEncodingConvertor());
    // Zstdè§£ç å™¨
    AbstractSaveResultResponseProcessor.addContentEncodingConvertor(new ZstdContentEncodingConvertor());
   
   // è®¾ç½®å…¨å±€Accept-Encoding
    HttpClientProxyObjectFactory httpFactory = new HttpClientProxyObjectFactory();
    String acceptEncoding;
    final StringBuilder sb = new StringBuilder();
    AbstractSaveResultResponseProcessor.getContentEncodingConvertors().forEach(cec -> sb.append(cec.contentEncoding()).append(", "));
    acceptEncoding = sb.substring(0, sb.length() - 2);
    httpFactory.addHeader("Accept-Encoding", acceptEncoding);
    ```
2. `SpringBoot`ç¯å¢ƒ  
`application.yml`

    ```yaml
    lucky:
      http-client:
        response-convert:
          # å¼€å¯å…¨å±€å†…å®¹å‹ç¼©åŠŸèƒ½
          enable-content-compress: true
          # è®¾ç½®Accept-Encoding, é»˜è®¤æƒ…å†µä¸‹ä¼šç»‘å®šæ‰€æœ‰æ”¯æŒçš„ç±»å‹
          accept-encoding: gzip, deflate, br, zstd
          # å¦‚æœéœ€è¦è‡ªå®šä¹‰å†…å®¹è§£ç å™¨ï¼Œè¯·åœ¨æ­¤å¤„æ³¨å†Œ
          content-encoding-decoder:
            - com.luckyframework.httpclient.core.encoder.BrotliContentEncodingConvertor
            - com.luckyframework.httpclient.core.encoder.ZstdContentEncodingConvertor
    ```


