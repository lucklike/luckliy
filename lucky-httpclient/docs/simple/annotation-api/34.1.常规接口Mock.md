## ğŸ¦‰ Mock

åœ¨ HTTP ç›¸å…³çš„å¼€å‘å’Œæµ‹è¯•ä¸­ï¼Œ`Mockï¼ˆæ¨¡æ‹Ÿï¼‰`æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œç”¨äºåˆ›å»ºè™šå‡çš„ HTTP è¯·æ±‚æˆ–å“åº”ï¼Œä»¥åœ¨æ²¡æœ‰çœŸå®åç«¯æœåŠ¡çš„æƒ…å†µä¸‹è¿›è¡Œæµ‹è¯•æˆ–å¼€å‘ã€‚

---

### # ä½¿ç”¨[@Mock](../../../src/main/java/com/luckyframework/httpclient/proxy/mock/Mock.java)æ³¨è§£å¼€å¯æ¨¡æ‹ŸåŠŸèƒ½

- `@Mock`**æ³¨è§£å±æ€§ä»‹ç»**

| å±æ€§                 | è¯´æ˜                                                                                                                                                                                                                                           | æ˜¯å¦æ”¯æŒSpELè¡¨è¾¾å¼ |
|--------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------:|
| `enable`           | æ˜¯å¦å¼€å¯MockåŠŸèƒ½ï¼Œé»˜è®¤å¼€å¯                                                                                                                                                                                                                              |      âœ…      |
| `status`           | æ¨¡æ‹Ÿå“åº”å—                                                                                                                                                                                                                                        |      âœ…      |
| `header`           | æ¨¡æ‹Ÿå“åº”å¤´ï¼Œæ ¼å¼`${key}:${value}`                                                                                                                                                                                                                    |      âœ…      |
| `body`             | æ¨¡æ‹Ÿå“åº”ä½“ï¼Œæ”¯æŒå¦‚ä¸‹è¿”å›å€¼ç±»å‹ï¼š<br/>`String`: æ–‡æœ¬ç±»å‹å“åº”ä½“ï¼Œå…·ä½“`Content-Type`éœ€è¦åœ¨`header`ä¸­é…ç½®<br/>`byte[]`/`InputStreamSource`/`ByteBuffer`: äºŒè¿›åˆ¶å“åº”ä½“ï¼Œå…·ä½“`Content-Type`éœ€è¦åœ¨`header`ä¸­é…ç½®<br/>`File`/`Resource`: èµ„æºç±»å‹å“åº”ä½“ï¼Œ`Content-Type`ä¼šè‡ªåŠ¨æ ¹æ®æ–‡ä»¶è·å–ï¼Œå¹¶ä¸”ä¼šè®¾ç½®`Content-Disposition` |      âœ…      |
| `mockResp`/`value` | ç”¨äºç”Ÿæˆ[MockResponse](../../../src/main/java/com/luckyframework/httpclient/proxy/mock/MockResponse.java)çš„`SpEL`è¡¨è¾¾å¼ï¼Œè¯¥å®ä¾‹è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„æ¨¡æ‹Ÿå“åº”ä½“                                                                                                              |      âœ…      |
| `mockFunc`         | æŒ‡å®šä¸€ä¸ªç”¨äºç”Ÿæˆ[MockResponse](../../../src/main/java/com/luckyframework/httpclient/proxy/mock/MockResponse.java)çš„`SpEL`å‡½æ•°                                                                                                                           |      âŒ      |
| `cache`            | æ˜¯å¦ç¼“å­˜ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„Mockå“åº”å¯¹è±¡ï¼Œé»˜è®¤å…³é—­                                                                                                                                                                                                                      |      âŒ      |

- **ä¼˜å…ˆçº§è¯´æ˜**

`mockResp` > `mockFunc` > `${methodName}$Mock` > `status + header + body`

### # ä½¿ç”¨`status`ã€`header`ã€`body` ç”Ÿæˆæ¨¡æ‹Ÿå“åº”ä½“

> - æ¨¡æ‹Ÿæ­£å¸¸å“åº”

```java

@DomainName("http://localhost:8080")
public interface MockApi {

    @Mock(
            status = "200",
            header = "Content-Type: text/html",
            body = "<!DOCTYPE html><html><body><h1>Hello World</h1></body></html>"
    )
    @Post("html")
    String html();
}
```

å“åº”ï¼š  
![mock-html-200.png](../../image/mock-html-200.png)

> - æ¨¡æ‹Ÿ`404`å“åº”

```java

@DomainName("http://localhost:8080")
public interface MockApi {

    @Mock(
            status = "404",
            body = "['#{$req$.getURI().getPath()}'] Not Fount!"
    )
    @Get("notFount")
    String _404();
}
```

å“åº”ï¼š  
![mock-404.png](../../image/mock-404.png)

> - æ¨¡æ‹Ÿ`500`å“åº”

```java

@DomainName("http://localhost:8080")
public interface MockApi {

    @Mock(
            status = "500",
            header = "Content-Type: application/json",
            body = "{\"code\": 500,\"message\": \"java.lang.ArrayIndexOutOfBoundsException: Index 5 out of bounds for length 2\"}"
    )
    @Get("error")
    String _500();
}
```

å“åº”ï¼š  
![mock-500.png](../../image/mock-500.png)

> - æ¨¡æ‹Ÿæ–‡ä»¶ä¸‹è½½å“åº”

æˆ‘ä»¬åœ¨`classpath`ä¸‹æ”¾ä¸€å¼ åç§°ä¸º`sheep.png`çš„å›¾ç‰‡ï¼Œç”¨äºæ¨¡æ‹Ÿæ–‡ä»¶å“åº”

```java

@DomainName("http://localhost:8080")
public interface MockApi {

    @Mock(body = "#{#resource('classpath:sheep.png')}")
    @Get("download/png")
    MultipartFile download();
}
```

å“åº”ï¼š  
![mock-download.png](../../image/mock-download.png)

---

### # ä½¿ç”¨`mockResp`ç”Ÿæˆæ¨¡æ‹Ÿå“åº”ä½“

`mockResp`æ”¯æŒ`SpEL`è¡¨è¾¾å¼ï¼Œæ­¤è¡¨è¾¾å¼ç»“æœå¿…é¡»ä¸º[MockResponse](../../../src/main/java/com/luckyframework/httpclient/proxy/mock/MockResponse.java)
å¯¹è±¡å®ä¾‹

```java

@DomainName("http://localhost:8080")
public interface MockApi {


    @Mock(mockResp = "#{$this$.mockRespDemo($mc$)}")
    @Post("mockResp")
    String mockResp(String p1, int p2);

    // æ„é€ æ¨¡æ‹Ÿå“åº”ä½“çš„æ–¹æ³•
    default MockResponse mockRespDemo(MethodContext mc) {
        MockResponse mockResp = MockResponse.create();
        // è®¾ç½®çŠ¶æ€ç 
        mockResp.status(200);
        // è®¾ç½®Content-Type
        mockResp.contentType("application/json");
        // è®¾ç½®Header
        mockResp.header(HttpHeaders.AUTHORIZATION, "234AC2BC3456");
        mockResp.header("CURR-METHOD", mc.getCurrentAnnotatedElement().getName());
        mockResp.header("CURR-METHOD-ARGS", Arrays.toString(mc.getArguments()));

        // è®¾ç½®å“åº”ä½“
        Map<String, Object> bodyMap = new LinkedHashMap<>();
        bodyMap.put("id", 11);
        bodyMap.put("name", "Lucky Client");
        bodyMap.put("version", "3.0.1");
        bodyMap.put("birthday", new Date());
        mockResp.json(bodyMap);

        return mockResp;
    }
}
```

å“åº”ï¼š  
![mock-mr-1.png](../../image/mock-mr-1.png)

---

### # ä½¿ç”¨`mockFunc`ç”Ÿæˆæ¨¡æ‹Ÿå“åº”ä½“

`mockFunc`æœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨`SpEL`å‡½æ•°æ¥ç”Ÿæˆ`MockResponse`å¯¹è±¡ï¼Œä¸`mockResp`ä¸åŒçš„æ˜¯ï¼Œ`mockFunc`åªç”¨æŒ‡å®šå‡½æ•°åå³å¯ï¼Œ
å‡½æ•°å‚æ•°ä¸ç”¨æ‰‹åŠ¨ä¼ é€’ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨è¿›è¡Œæ¨æ–­ã€‚

```java
@DomainName("http://localhost:8080")
public interface MockApi {

    @Mock(mockFunc = "mockFuncDemo")
    @Post("mockFunc")
    Map<String, Object> mockFunc(String p1, String p2);

    // æ„é€ æ¨¡æ‹Ÿå“åº”ä½“çš„æ–¹æ³•ï¼ŒSpELå‡½æ•°æ–¹æ³•å¿…é¡»æ˜¯staticä¿®é¥°çš„
    static MockResponse mockFuncDemo(Method method, @Param("#{$args$}") Object[] args) {
        MockResponse mockResp = MockResponse.create();
        // è®¾ç½®çŠ¶æ€ç 
        mockResp.status(200);
        // è®¾ç½®Content-Type
        mockResp.contentType("application/x-java-serialized-object");
        // è®¾ç½®Header
        mockResp.header(HttpHeaders.AUTHORIZATION, "234AC2BC3456");
        mockResp.header("CURR-METHOD", method.getName());
        mockResp.header("CURR-METHOD-ARGS", Arrays.toString(args));

        // è®¾ç½®å“åº”ä½“
        LinkedHashMap<String, Object> bodyMap = new LinkedHashMap<>();
        bodyMap.put("id", 12);
        bodyMap.put("name", "Spring Boot");
        bodyMap.put("version", "2.0.1");
        bodyMap.put("birthday", new Date());
        mockResp.java(bodyMap);

        return mockResp;
    }
}
```

å“åº”ï¼š  
![mock-mf.png](../../image/mock-mf.png)

---

### # ä½¿ç”¨`çº¦å®šSpELæ–¹æ³•`æ¥å®Œæˆæ¨¡æ‹Ÿ

åŠ ä¸Š`@Mock`æ³¨è§£è€Œä¸”`ä¸åšä»»ä½•é…ç½®`æ—¶ï¼Œluckyä¼šå°è¯•å»æŸ¥æ‰¾æœ‰æ²¡æœ‰`çº¦å®šçš„Mockæ–¹æ³•`ï¼Œå¦‚æœæœ‰åˆ™ä¼šç›´æ¥çº¦å®šæ–¹æ³•æ¥å®Œæˆ
Mockæ“ä½œã€‚

- çº¦å®šæ–¹æ³•çš„å‘½åè§„èŒƒï¼š
>` ${targetMethodName}+$Mock`

```java
@DomainName("http://localhost:8080")
public interface MockApi {
    
    // enable = "${mock.enable:true}"è¡¨ç¤ºæ˜¯å¦å¼€å¯MockåŠŸèƒ½å–å†³äºSpringç¯å¢ƒå˜é‡${mock.enable}ï¼Œæ²¡é…ç½®æ—¶é»˜è®¤å¼€å¯
    @Mock(enable = "${mock.enable:true}")
    @Get("download/#{fileName}")
    MultipartFile appoint(String fileName);

    // appointæ–¹æ³•çº¦å®šçš„Mockæ–¹æ³•ã€${targetMethodName} + $Mockã€‘ -> appoint$Mock
    static MockResponse appoint$Mock(@Param("#{fileName}") String fileName) {
        MockResponse mockResponse = MockResponse.create();
        mockResponse.status(200);
        mockResponse.resource(String.format("classpath:%s", fileName));
        return mockResponse;
    }
}
```

å“åº”ï¼š  
![mock-ma.png](../../image/mock-ma.png)

---
### # SSEå“åº”Mock

- ä½¿ç”¨[SseMock](../../../src/main/java/com/luckyframework/httpclient/proxy/mock/SseMock.java)æ¥ç”ŸæˆSSEæ¨¡æ‹Ÿå“åº”æ•°æ®

```java
@DomainName("http://localhost:8080")
public interface MockApi {

    @Sse
    @Mock
    @Post("sse")
    void sse(EventListener listener);


    static MockResponse sse$Mock() {
        MockResponse mockResponse = MockResponse.create();
        mockResponse.status(200);
        mockResponse.sse(
                SseMock.create()
                        .addSection(
                                SseMock.section()
                                        .id("ID-1")
                                        .event("msg")
                                        .data("Hello World")
                        ).addData("ä½ å¥½ä½ å¥½ï¼")
        );
        return mockResponse;
    }
}
```

å“åº”ï¼š  
![sse-apiset.png](../../image/sse-apiset.png)

- ä»æ–‡ä»¶ä¸­è¯»å–SSEå“åº”å†…å®¹

åœ¨`classpath`ä¸‹å®šä¹‰ä¸€ä¸ªåç§°ä¸º`sse-mock.data`çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
id: 1
event: msg
data: ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯ä¸€åç¨‹åºå‘˜

id: 2
event: msg
data: æ¨èä¸€æ¬¾å¥½ç”¨çš„Java HTTPå®¢æˆ·ç«¯æ¡†æ¶ç»™ä½ ä»¬

id: 3
event: msg
data: lucky-httpclientï¼Œgithubåœ°å€ï¼šhttps://github.com/lucklike/luckliy/tree/main/lucky-httpclient

data: [END]
```

```java
@DomainName("http://localhost:8080")
public interface MockApi {

    @Sse
    @Mock
    @Post("sse2")
    void sse2(EventListener listener);


    static MockResponse sse2$Mock() {
        MockResponse mockResponse = MockResponse.create();
        mockResponse.status(200);
        mockResponse.sse(SseMock.resource("classpath:sse-mock.data"));
        return mockResponse;
    }
}
```
å“åº”ï¼š  
![mock-resource.png](../../image/mock-resource.png)





