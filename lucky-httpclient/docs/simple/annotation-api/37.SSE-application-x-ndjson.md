## ğŸ¹ `application/x-ndjson`

`application/x-ndjson `æ˜¯ä¸€ç§ MIME ç±»å‹ï¼Œç”¨äºè¡¨ç¤º` NDJSON `(Newline Delimited JSON) æ ¼å¼çš„æ•°æ®ã€‚NDJSON æ˜¯ä¸€ç§ä»¥æ¢è¡Œç¬¦åˆ†éš”çš„ JSON æ ¼å¼ï¼Œå¸¸ç”¨äºæµå¼å¤„ç†å’Œæ—¥å¿—è®°å½•ç­‰åœºæ™¯ï¼Œå°¤å…¶é€‚ç”¨äºéœ€è¦é€æ¡å¤„ç†å¤§é‡ JSON æ•°æ®çš„åº”ç”¨ã€‚ä¸‹é¢æ˜¯å¯¹å®ƒçš„ä¸€äº›è¯¦ç»†ä»‹ç»ï¼š

1. ### NDJSON æ ¼å¼
   - NDJSON æ˜¯ä¸€ç§æ–‡æœ¬æ ¼å¼ï¼Œå…¶ä¸­æ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„` JSON `å¯¹è±¡ã€‚
   - æ¯ä¸ª` JSON `å¯¹è±¡éƒ½åœ¨ä¸€è¡Œä¸­ï¼Œå¹¶ä¸”è¡Œä¸è¡Œä¹‹é—´ç”±æ¢è¡Œç¬¦ (`\n`) åˆ†éš”ã€‚
   - è¿™ç§æ ¼å¼çš„å…³é”®ä¼˜åŠ¿æ˜¯å¯ä»¥å¤„ç†å’Œä¼ è¾“å¤§é‡çš„` JSON `æ•°æ®ï¼Œè€Œæ— éœ€å°†æ‰€æœ‰æ•°æ®éƒ½åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿™å¯¹äºæµå¤„ç†éå¸¸æœ‰ç”¨ã€‚
2. ### é€‚ç”¨åœºæ™¯
   - **æ—¥å¿—è®°å½•**ï¼šç”±äºå…¶æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡çš„ç»“æ„ï¼ŒNDJSON éå¸¸é€‚ç”¨äºæ—¥å¿—æ•°æ®çš„å­˜å‚¨å’Œå¤„ç†ã€‚
   - **æ•°æ®æµä¼ è¾“**ï¼šNDJSON ä¹Ÿé€‚ç”¨äºéœ€è¦é€æ¡ä¼ è¾“æˆ–é€æ¡å¤„ç†æ•°æ®çš„æƒ…å†µï¼Œæ¯”å¦‚å®æ—¶æ•°æ®ä¼ è¾“ã€æ•°æ®æµå¤„ç†ã€æˆ–è€…å¤§è§„æ¨¡æ‰¹å¤„ç†ä»»åŠ¡ã€‚
   - **æ•°æ®å¤„ç†ç®¡é“**ï¼šNDJSON åœ¨æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ç»å¸¸è¢«ç”¨ä½œä¸­é—´æ ¼å¼ï¼Œæ–¹ä¾¿åœ¨ä¸åŒå¤„ç†é˜¶æ®µè¿›è¡Œæµå¼è¯»å–å’Œå†™å…¥ã€‚
3. ### ä¸ JSON çš„åŒºåˆ«
   - **JSON**ï¼ˆJavaScript Object Notationï¼‰é€šå¸¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ JSON æ–‡æ¡£ï¼Œå®ƒæ˜¯ä¸€ä¸ªå±‚çº§åŒ–çš„ç»“æ„ï¼Œæ•´ä¸ªæ–‡æ¡£æ˜¯ä¸€ä¸ªå¤§çš„ JSON å¯¹è±¡ã€‚
   - **NDJSON** æ˜¯ç”±å¤šä¸ªç‹¬ç«‹çš„ JSON å¯¹è±¡ç»„æˆçš„æµï¼Œæ¯ä¸ªå¯¹è±¡å•ç‹¬ä¸€è¡Œï¼Œå¯ä»¥æŒ‰è¡Œè¯»å–æˆ–å¤„ç†ã€‚

4. ### ç¤ºä¾‹

    å‡è®¾æˆ‘ä»¬æœ‰ä¸€äº›ç”¨æˆ·æ•°æ®ï¼Œæ¯ä¸ªç”¨æˆ·ä¿¡æ¯éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ JSON å¯¹è±¡ï¼Œå­˜å‚¨åœ¨ NDJSON æ ¼å¼ä¸­ï¼š
    ```json
    {"id": 1, "name": "Alice", "email": "alice@example.com"}
    {"id": 2, "name": "Bob", "email": "bob@example.com"}
    {"id": 3, "name": "Charlie", "email": "charlie@example.com"}
    ```
   è¿™æ®µæ•°æ®æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåµŒå¥—çš„ JSON æ•°ç»„ã€‚

---

### # ä½¿ç”¨[NdJsonEventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/ndjson/NdJsonEventListener.java)ç›‘å¬å™¨æ¥ç›‘å¬`NDJSON`æ ¼å¼æ•°æ®

ç»§æ‰¿è‡ªNdJsonEventListenerçš„ç±»éƒ½éœ€è¦æä¾›ä¸€ä¸ªå…·ä½“çš„æ³›å‹ç±»å‹ï¼ŒNdJsonEventListeneråœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åä¼šè‡ªåŠ¨çš„å°†Jsonæ•°æ®è½¬æˆè¯¥æ³›å‹ç±»å‹çš„javaå¯¹è±¡ã€‚

ä»¥`Ollama`æä¾›çš„[å›ç­”è¡¥å…¨](https://github.com/datawhalechina/handy-ollama/blob/main/docs/C4/1.%20Ollama%20API%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97.md#%E4%B8%80%E5%9B%9E%E7%AD%94%E8%A1%A5%E5%85%A8)APIä¸ºä¾‹æ¥è¿›è¡Œè¯´æ˜

![ollama-api.png](../../image/ollama-api.png)

1. å®šä¹‰`Ollama`æ¥å£

- å£°æ˜å®ä½“ç±»-Request
```java
@Data
public class GenerateRequest {

   /**
    * æ¨¡å‹åç§°
    */
   private String model;
    
   /**
    * å¦‚æœè®¾ç½®ä¸º false ï¼Œå“åº”å°†ä½œä¸ºå•ä¸ªå“åº”å¯¹è±¡è¿”å›ï¼Œè€Œä¸æ˜¯ä¸€ç³»åˆ—å¯¹è±¡æµ
    */
   private Boolean stream = true;

   /**
    * è¦ç”Ÿæˆå“åº”çš„æç¤º
    */
   private String prompt;

   /**
    * æ¨¡å‹å“åº”åçš„æ–‡æœ¬
    */
   private String suffix;

   /**
    * ï¼ˆå¯é€‰ï¼‰ä¸€ä¸ªbase64ç¼–ç çš„å›¾åƒåˆ—è¡¨ï¼ˆç”¨äºå¤šæ¨¡æ€æ¨¡å‹ï¼Œå¦‚ llava ï¼‰
    */
   private String images;

   /**
    * è¿”å›å“åº”çš„æ ¼å¼ã€‚ç›®å‰å”¯ä¸€æ¥å—çš„å€¼æ˜¯ json
    */
   private String format;

   /**
    * å…¶ä»–æ¨¡å‹å‚æ•°ï¼Œå¦‚ temperatureã€seed ç­‰
    */
   private String options;

   /**
    * ç³»ç»Ÿæ¶ˆæ¯
    */
   private String system;

   /**
    * è¦ä½¿ç”¨çš„æç¤ºæ¨¡æ¿
    */
   private String template;

   /**
    * ä»å…ˆå‰å¯¹ /generate çš„è¯·æ±‚ä¸­è¿”å›çš„ä¸Šä¸‹æ–‡å‚æ•°ï¼Œå¯ä»¥ç”¨äºä¿æŒç®€çŸ­çš„å¯¹è¯è®°å¿†
    */
   private Integer[] context;

   /**
    * å¦‚æœè®¾ç½®ä¸º true ï¼Œå°†ä¸ä¼šå¯¹æç¤ºè¿›è¡Œä»»ä½•æ ¼å¼åŒ–ã€‚å¦‚æœæ‚¨åœ¨è¯·æ±‚APIæ—¶æŒ‡å®šäº†å®Œæ•´çš„æ¨¡æ¿æç¤ºï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ raw å‚æ•°
    */
   private Boolean raw;

   /**
    * æ§åˆ¶æ¨¡å‹åœ¨è¯·æ±‚åä¿ç•™åœ¨å†…å­˜ä¸­çš„æ—¶é—´ï¼ˆé»˜è®¤ï¼š5mï¼‰
    */
   private String keep_alive;
}
```

- å£°æ˜å®ä½“ç±»-Response 

```java
@Data
public class GenerateResponse {

   /**
    * æ¨¡å‹åç§°
    */
   private String model;

   /**
    * æ—¶é—´
    */
   private String created_at;

   /**
    * æ˜¯å¦å·²ç»ç»“æŸ
    */
   private Boolean done;

   /**
    * åœæ­¢çš„åŸå› 
    */
   private String done_reason;

   /**
    * ç”Ÿæˆå“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    */
   private Long total_duration;

   /**
    * åŠ è½½æ¨¡å‹æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    */
   private Long load_duration;

   /**
    * æç¤ºä¸­çš„æ ‡è®°æ•°é‡
    */
   private Integer prompt_eval_count;

   /**
    * è¯„ä¼°æç¤ºæ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    */
   private Long prompt_eval_duration;

   /**
    * å“åº”ä¸­çš„æ ‡è®°æ•°é‡
    */
   private Integer eval_count;

   /**
    * ç”Ÿæˆå“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆçº³ç§’ï¼‰
    */
   private Long eval_duration;
    
   /**
    * å“åº”å†…å®¹
    */
   private String response;

   /**
    * ç”¨äºæ­¤å“åº”çš„å¯¹è¯ç¼–ç ï¼Œå¯ä»¥åœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚ä¸­å‘é€ä»¥ä¿æŒå¯¹è¯è®°å¿†
    */
   private Integer[] context;
}
```

- å®šä¹‰å›ç­”è¡¥å…¨æ¥å£
```java
@DomainName("http://localhost:11434")
public interface OllamaApi {

   @Sse
   @Post("/api/generate")
   @Describe("ï¼ˆæµå¼ï¼‰å›ç­”è¡¥å…¨")
   void streamGenerate(@JsonBody GenerateRequest request, EventListener listener);
}
```
- å®šä¹‰äº‹ä»¶ç›‘å¬å™¨
```java
public class OllamaGenerateEventListener extends NdJsonEventListener<GenerateResponse> {

   @Override
   public void onOpen(Event<Response> event) throws Exception {
      System.out.println("è¿æ¥å·²å»ºç«‹ï¼");
   }

   @Override
   public void onMessage(Event<GenerateResponse> event) throws Exception {
      GenerateResponse message = event.getMessage();
      if (message.getDone()) {
         System.out.println("\nOllama API å“åº”ç»“æŸ");
      } else {
         System.out.print(message.getResponse());
      }
   }

   @Override
   public void onError(Event<Throwable> event) {
      System.out.println("å‘ç”Ÿå¼‚å¸¸: " + event.getMessage().getMessage());
   }


   @Override
   public void onClose(Event<Void> event) {
      System.out.println("è¿æ¥å·²å…³é—­");
   }

}
```

- ç¼–å†™å•å…ƒæµ‹è¯•ç±»
```java
@SpringBootTest
class OllamaApiTest {

    @Resource
    private OllamaApi api;

    @Test
    void streamGenerate0() {
        OllamaGenerateEventListener listener = new OllamaGenerateEventListener();
        GenerateRequest request = new GenerateRequest();
        request.setPrompt("ä½ å¥½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªç¨‹åºå‘˜ï¼Œå¸®æˆ‘å†™ä¸€ä¸ª100å­—å·¦å³çš„è‡ªæˆ‘ä»‹ç»ï¼Œ");
        request.setModel("deepseek-r1:1.5b");
        api.streamGenerate(request, listener);
    }
}
```


è¯·æ±‚ï¼š  
![ollama-req.png](../../image/ollama-req.png)

å“åº”ï¼š  
![ollama-resp.png](../../image/ollama-resp.png)

---

### #ä½¿ç”¨[AnnotationNdJsonEventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/ndjson/AnnotationNdJsonEventListener.java)ç›‘å¬å™¨æ¥ç›‘å¬`NDJSON`æ ¼å¼æ•°æ®

æ­¤ç›‘å¬å™¨ç±»ä¼¼[AnnotationStandardEventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/AnnotationStandardEventListener.java)ï¼Œæ‰©å±•äº†`onMessage`æ–¹æ³•ï¼Œæä¾›äº†åŸºäº[@OnMessage](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/OnMessage.java)æ³¨è§£çš„`æ¶ˆæ¯è·¯ç”±`ä¸`æ¶ˆæ¯è·å–`çš„èƒ½åŠ›ã€‚
å…·ä½“åŠŸèƒ½æè¿°ä¸å†èµ˜è¿°ï¼

ä½¿ç”¨`AnnotationNdJsonEventListener`ç±»æ”¹é€ ä¸Šè¿°æ¡ˆä¾‹
```java
public class OllamaAnnotationGenerateEventListener extends AnnotationNdJsonEventListener<GenerateResponse> {

   @OnMessage("#{$data$.done}")
   public void clear() {
      System.out.println("\nOllama API å“åº”ç»“æŸ");
   }

   @OnMessage
   public void output(GenerateResponse response) {
      System.out.print(message.getResponse());
   }
}
```