## ğŸ¸ `text/event-stream`

`text/event-stream `æ˜¯ä¸€ç§ç”¨äº Server-Sent Events (SSE) çš„ MIME ç±»å‹ï¼Œè¡¨ç¤ºæœåŠ¡å™¨é€šè¿‡ HTTP åè®®å‘å®¢æˆ·ç«¯æ¨é€äº‹ä»¶æµçš„æ•°æ®æ ¼å¼ã€‚SSE
ä½¿ç”¨è¿™ç§æ ¼å¼æ¥å®æ—¶ä¼ é€’æ•°æ®æµã€‚ä¸ WebSocket æˆ–è½®è¯¢ä¸åŒï¼ŒSSE è®©æœåŠ¡å™¨ä¸»åŠ¨å°†æ•°æ®å‘é€åˆ°æµè§ˆå™¨ï¼Œè€Œä¸æ˜¯è®©æµè§ˆå™¨é¢‘ç¹è¯·æ±‚æ•°æ®ã€‚

#### `text/event-stream `æ ¼å¼æ¦‚è¿°ï¼š

æ•°æ®æµç”±ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ç»„æˆï¼Œæ¯ä¸ªäº‹ä»¶ä»¥æ–‡æœ¬å½¢å¼é€šè¿‡ HTTP æŒç»­ä¼ è¾“ã€‚æ¯ä¸ªäº‹ä»¶ç”±ä¸åŒçš„å­—æ®µç»„æˆï¼Œæ¯ä¸ªå­—æ®µç”¨æ¢è¡Œç¬¦ï¼ˆ\nï¼‰åˆ†éš”ã€‚æ¯ä¸ªäº‹ä»¶é€šå¸¸ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- `event`ï¼ˆå¯é€‰ï¼‰ï¼šæŒ‡å®šäº‹ä»¶çš„ç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯ `"message"`ï¼Œä½†å¯ä»¥ç”¨å®ƒæ¥æ ‡è¯†ä¸åŒç±»å‹çš„äº‹ä»¶ã€‚
- `data`ï¼ˆå¿…éœ€ï¼‰ï¼šäº‹ä»¶çš„æœ‰æ•ˆæ•°æ®ã€‚é€šå¸¸æ˜¯è¦æ¨é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œé€šå¸¸æ˜¯JSONæ ¼å¼æˆ–çº¯æ–‡æœ¬ã€‚
- `id`ï¼ˆå¯é€‰ï¼‰ï¼šäº‹ä»¶çš„æ ‡è¯†ç¬¦ã€‚é€šå¸¸ç”¨äºå®ç°äº‹ä»¶çš„é¡ºåºæˆ–åœ¨æ–­çº¿é‡è¿æ—¶ç»§ç»­æ¥æ”¶äº‹ä»¶ã€‚
- `retry`ï¼ˆå¯é€‰ï¼‰ï¼šæŒ‡å®šå®¢æˆ·ç«¯åœ¨è¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿çš„æ—¶é—´é—´éš”ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰ã€‚

#### `text/event-stream` æ ¼å¼ç¤ºä¾‹ï¼š

ä¸€ä¸ªç®€å•çš„ `text/event-stream` æ•°æ®æµå¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
# æ•°æ®æ®µä¸€
event: message
data: Hello, World!

# æ•°æ®æ®µäºŒ
event: customEvent
data: { "key": "value", "status": "active" }

# æ•°æ®æ®µä¸‰
id: 123
data: This is a continuation of the last message

# æ•°æ®æ®µå››
retry: 10000

```

---

### # ä½¿ç”¨[StandardEventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/StandardEventListener.java)æ¥ç›‘å¬`text/event-stream`æ ¼å¼æ•°æ®

`StandardEventListener`ç»§æ‰¿è‡ª`EventListener`ï¼Œé’ˆå¯¹`text/event-stream`æ ¼å¼æ•°æ®è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†æ›´åŠ æ–¹ä¾¿çš„æ•°æ®æ“ä½œAPIã€‚

- [StandardEventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/StandardEventListener.java)
  ä¸»è¦APIä»‹ç»

| æ–¹æ³•                                      | è¯´æ˜                                                                                                                                                                   |
|-----------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `void onOpening(Event<Response> event)` | å½“è¿æ¥å»ºç«‹æ—¶è§¦å‘                                                                                                                                                             |
| `void onMessage(Event<Message> event)`  | å½“æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„ä¸€æ®µå®Œæ•´çš„æ¶ˆæ¯ä¹‹åå‡ºå‘ï¼Œ`text/event-stream`æ•°æ®ä¼šè¢«å°è£…ä¸º[Message](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/Message.java)å¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¥è·å–æ¶ˆæ¯æ•°æ® |
| `void onError(Event<Throwable> event) ` | å½“å‘ç”Ÿå¼‚å¸¸æ—¶è§¦å‘                                                                                                                                                             |
| `void onClosed(Event<Void> event)`      | å½“è¿æ¥å…³é—­æ—¶è§¦å‘                                                                                                                                                             |

- [Message](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/Message.java)ä¸»è¦APIä»‹ç»

| æ–¹æ³•                                                                | è¯´æ˜                                              |
|-------------------------------------------------------------------|-------------------------------------------------|
| `String getId()`                                                  | è·å–äº‹ä»¶çš„æ ‡è¯†ç¬¦`id: xxx `                              |
| `String getEvent()`                                               | è·å–äº‹ä»¶ç±»å‹`event: xxx`                              |
| `String getData()`                                                | è·å–äº‹ä»¶å…·ä½“æ•°æ®`data: xxx`                             |
| `String getRetry()`                                               | è·å–äº‹ä»¶è‡ªåŠ¨é‡è¿çš„æ—¶é—´é—´éš”`retry: xxx`                       |
| `String getComment()`                                             | è·å–æ³¨é‡Šä¿¡æ¯`: xxx `                                  |
| `String getProperty(String key)`                                  | è·å–æŒ‡å®škeyçš„æ•°æ® `${key}: xxx `                       |
| `T fromJsonData(SerializationTypeToken<T> token)`                 | å°†`JSON`æ ¼å¼çš„`data:`æ•°æ®è½¬ä¸º`Javaå®ä½“ `                  |
| `T fromJsonData(Type type)`                                       | å°†`JSON`æ ¼å¼çš„`data:`æ•°æ®è½¬ä¸º`Javaå®ä½“`                   |
| `ConfigurationMap jsonDataToMap()`                                | å°†`JSON`æ ¼å¼çš„`data:`æ•°æ®è½¬ä¸º`ConfigurationMap`å¯¹è±¡       |
| `T fromJsonProperty(String key, SerializationTypeToken<T> token)` | å°†æŒ‡å®škeyçš„`JSON`æ ¼å¼`${key}:`æ•°æ®è½¬ä¸º`Javaå®ä½“ `           |
| `<T> T fromJsonProperty(String key, Type type)`                   | å°†æŒ‡å®škeyçš„`JSON`æ ¼å¼`${key}:`æ•°æ®è½¬ä¸º`Javaå®ä½“ `           |
| `ConfigurationMap jsonPropertyToMap(String key) `                 | å°†æŒ‡å®škeyçš„`JSON`æ ¼å¼`${key}:`æ•°æ®è½¬ä¸º`ConfigurationMap ` |

---

### # ç¤ºä¾‹ä»£ç 
> è¿˜æ˜¯ä»¥`DeepSeek`å®˜ç½‘æä¾›çš„[å¯¹è¯APIä¸º](https://api-docs.deepseek.com/zh-cn/)ä¾‹æ¥è¿›è¡Œè¯´æ˜ï¼š

DeepSeekApiå“åº”ç»“æœçš„`data:`éƒ¨åˆ†å¦‚ä¸‹ï¼š
```json
{
  "id": "8cdd7249-d88f-4481-b33b-a90a0a2d1886",
  "object": "chat.completion.chunk",
  "created": 1740712104,
  "model": "deepseek-chat",
  "system_fingerprint": "fp_3a5770e1b4_prod0225",
  "choices": [
    {
      "index": 0,
      "delta": {
        "content": "å›å¤å†…å®¹"
      },
      "logprobs": null,
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 11,
    "completion_tokens": 12,
    "total_tokens": 23,
    "prompt_tokens_details": {
      "cached_tokens": 0
    },
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 11
  }
}
```

1. ä½¿ç”¨`StandardEventListener`æ¥æ”¹é€ ç›‘å¬å™¨ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬åªå–`å›å¤å†…å®¹`éƒ¨åˆ†è¿›è¡Œæ‰“å°

`DeepSeekStandardEventListener`
```java
public class DeepSeekStandardEventListener extends StandardEventListener {

  @Override
  protected void onOpening(Event<Response> event) throws Exception {
    System.out.println("è¿æ¥å·²å»ºç«‹ï¼");
  }

  @Override
  protected void onMessage(Event<Message> event) throws Exception {
    Message message = event.getMessage();
    if ("[DONE]".equals(message.getData().trim())) {
      System.out.println("DeepSeekå›å¤ç»“æŸ.");
    } else {
      // å°†Jsonæ ¼å¼çš„data: æ•°æ®è½¬åŒ–ä¸ºConfigurationMapå¯¹è±¡
      ConfigurationMap jsonMap = message.jsonDataToMap();
      // è·å–å›å¤å†…å®¹ã€choices[0].delta.contentã€‘å¹¶æ‰“å°
      System.out.println(jsonMap.getProperty("choices[0].delta.content"));
    }
  }


  @Override
  public void onError(Event<Throwable> event) {
    System.out.println("å‘ç”Ÿå¼‚å¸¸: " + event.getMessage().getMessage());
  }


  @Override
  protected void onClosed(Event<Void> event) {
    System.out.println("è¿æ¥å·²å…³é—­");
  }
}

```
2. ä½¿ç”¨`DeepSeekStandardEventListener`æ¥æ”¹é€ ä¹‹å‰çš„`DeepSeekApi`æ¥å£
```java
@DomainName("${DeepSeek.url}")
public interface DeepSeekApi {

   /*
      é€šè¿‡@Sseæ³¨è§£çš„listenerClassæ¥ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œè¿™æ¬¡ç»‘å®šDeepSeekStandardEventListener
    */
   @Sse(listenerClass = DeepSeekStandardEventListener.class)
   @StaticJsonBody("``#{#read(#resource('classpath:deepseek-param.json'))}``")
   @StaticHeader("Authorization: Bearer ${DeepSeek.apiKey}")
   @Post("/chat/completions")
   void completions(String content);

}
```

è¯·æ±‚ï¼š  
![sdp-req.png](../../image/sdp-req.png)
å“åº”ï¼š  
![sdp-resp.png](../../image/sdp-resp.png)


---
### # ä½¿ç”¨[AnnotationStandardEventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/AnnotationStandardEventListener.java)æ¥ç›‘å¬`text/event-stream`æ ¼å¼æ•°æ®

`AnnotationStandardEventListener`ç»§æ‰¿è‡ª`StandardEventListener`ï¼Œæ‰©å±•äº†`onMessage`æ–¹æ³•ï¼Œæä¾›äº†åŸºäº[@OnMessage](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/OnMessage.java)æ³¨è§£çš„`æ¶ˆæ¯è·¯ç”±`ä¸`æ¶ˆæ¯è·å–`çš„èƒ½åŠ›

> ä½¿ç”¨`@OnMessage`æ³¨è§£æ¥åšæ¶ˆæ¯è·¯ç”±

`AnnotationStandardEventListener`åœ¨åˆå§‹åŒ–æ—¶ä¼šæ”¶é›†ç±»ä¸­æ‰€æœ‰è¢«`@OnMessage`æ ‡æ³¨çš„æ–¹æ³•ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª`ä¸¥æ ¼æŒ‰ç…§æ–¹æ³•å£°æ˜é¡ºåº`æ’åˆ—çš„é›†åˆï¼Œ
åœ¨`onMessageæ–¹æ³•`æ‰§è¡Œæ—¶ä¼šæŒ‰ç…§é¡ºåºéå†æ‰€æœ‰`@OnMessage`æ–¹æ³•ï¼Œå¹¶åˆ¤æ–­`@OnMessage`æ³¨è§£ä¸­çš„`value`å±æ€§å¯¹åº”çš„`SpELè¡¨è¾¾å¼`ç»“æœæ˜¯å¦ä¸º`true`ï¼Œå¦‚æœä¸º`true`
åˆ™ä¼šæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å¹¶ç»“æŸ`onMessageæ–¹æ³•`æ–¹æ³•çš„æ‰§è¡Œï¼Œåä¹‹åˆ™ä¼šæŒ‰ç…§é¡ºåºç»§ç»­ä¾¿åˆ©ï¼Œç›´åˆ°æ‰¾åˆ°è¡¨è¾¾å¼ç»“æœä¸º`true`çš„æ–¹æ³•ä¸ºæ­¢ã€‚  
ä¾‹å¦‚ï¼š

```java
// å½“äº‹ä»¶ç±»å‹ï¼ˆevent: éƒ¨åˆ†ï¼‰ä¸º'message'æ—¶æ‰§è¡Œ
@OnMessage("#{$event$ eq 'message'}")
public void m1(){
    //......
}

// å½“äº‹ä»¶IDï¼ˆid: éƒ¨åˆ†ï¼‰ä¸º'213232'æ—¶æ‰§è¡Œ
@OnMessage("#{$id$ eq '213232'}")
public void m2(){
  //......
}
```

> æ–¹æ³•å‚æ•°è·å–é€»è¾‘

1. ç‰¹æ®Šç±»å‹å‚æ•°

- [Event](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/Event.java)
- [Context](../../../src/main/java/com/luckyframework/httpclient/proxy/context/Context.java)
- [Message](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/standard/Message.java)
- [MessageMethod](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/MessageMethod.java)
- [This(è‡ªèº«)]()

2. ä½¿ç”¨`@Param`æ³¨è§£æ¥ä½¿ç”¨`SpELè¡¨è¾¾å¼`ï¼Œè¡¨è¾¾å¼ç»“æœå°†ä¼šè¢«æ³¨å…¥åˆ°å¯¹åº”çš„å‚æ•°ä¸­

- `@Param("#{#uuid()}")`: æ³¨å…¥ä¸€ä¸ªéšæœºçš„UUID
- `@Param("#{$this$}")`: æ³¨å…¥å½“å‰ç›‘å¬å™¨å¯¹è±¡å®ä¾‹
- `@Param("#{$jdata$}")`:æ³¨å…¥è¢«è½¬åŒ–ä¸ºJavaå¯¹è±¡çš„`data:`éƒ¨åˆ†æ•°æ®(`åªæœ‰åœ¨dataæ•°æ®ä¸ºjsonæ ¼å¼æ‰èƒ½ä½¿ç”¨`)
- `@Param("#{$data$}")`:æ³¨å…¥åŸå§‹`data:`æ•°æ®  
- å…¶ä»–å¯ä»¥ä½¿ç”¨`SpELRootå¯¹è±¡`è¯·è‡ªè¡Œåˆ°`AnnotationStandardEventListener`ç±»ä¸­æŸ¥çœ‹

3. å¦‚æœæ˜¯`SpringBoot`ç¯å¢ƒï¼Œåˆ™è¿˜æ”¯æŒå¦‚ä¸‹å‚æ•°

- `@Valueæ³¨è§£`ï¼šæ³¨å…¥`Springç¯å¢ƒå˜é‡`ä¸­çš„å˜é‡
- `@Qualifieræ³¨è§£`ï¼šæŒ‰åç§°æ³¨å…¥`Springå®¹å™¨`ä¸­çš„`Bean`
- å…¶ä»–ç±»å‹ä¼šå°è¯•é€šè¿‡ç±»å‹åˆ°Springå®¹å™¨ä¸­è·å–Bean

æ”¹é€ ååŸºäº`AnnotationStandardEventListener`å®ç°çš„ç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨å¯ä»¥å®Œæˆç›¸åŒçš„æ•ˆæœ

```java
public class DeepSeekAnnotationStandardEventListener extends AnnotationStandardEventListener {

  @OnMessage("#{$data$.trim() eq '[DONE]'}")
  public void msgEnd() {
    System.out.println("DeepSeekå›å¤ç»“æŸ.");
  }

  @OnMessage
  public void printMsg(@Param("#{$jdata$.choices[0].delta.content}") String msg) {
    System.out.print(msg);
  }
}
```