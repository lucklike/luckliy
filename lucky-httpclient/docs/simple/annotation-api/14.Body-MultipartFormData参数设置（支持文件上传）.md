## ğŸ—ƒï¸ `multipart/form-data`å‚æ•°è®¾ç½®

---
`multipart/form-data` æ˜¯ä¸€ç§ç¼–ç ç±»å‹ï¼Œç”¨äºé€šè¿‡ HTTP è¯·æ±‚ä¸Šä¼ æ–‡ä»¶å’Œæ•°æ®ã€‚å½“ç”¨æˆ·é€šè¿‡ HTML è¡¨å•æäº¤æ•°æ®æ—¶ï¼Œå°¤å…¶æ˜¯åŒ…å«æ–‡ä»¶ä¸Šä¼ çš„è¡¨å•ï¼Œ`multipart/form-data` å°±æ˜¯å¸¸ç”¨çš„ç¼–ç æ ¼å¼ã€‚

### ç”¨é€”
`multipart/form-data` ä¸»è¦ç”¨äºå…è®¸ç”¨æˆ·é€šè¿‡ Web è¡¨å•ä¸Šä¼ æ–‡ä»¶ã€‚å®ƒå°†è¡¨å•æ•°æ®åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†å¯ä»¥åŒ…å«ä¸€ä¸ªå­—æ®µæˆ–ä¸€ä¸ªæ–‡ä»¶ï¼Œæœ€ç»ˆè¿™äº›éƒ¨åˆ†ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ä½“ã€‚è¿™ç§æ ¼å¼å¯ä»¥ä¼ é€’äºŒè¿›åˆ¶æ–‡ä»¶ä»¥åŠå…¶ä»–ç±»å‹çš„æ•°æ®ï¼ˆå¦‚æ–‡æœ¬å­—æ®µï¼‰ã€‚

### å·¥ä½œåŸç†
å½“æµè§ˆå™¨é€šè¿‡ POST è¯·æ±‚å‘é€è¡¨å•æ—¶ï¼Œè¡¨å•ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½åŒ…å«åœ¨ä¸€ä¸ªå¤šéƒ¨åˆ†çš„å†…å®¹ä¸­ï¼Œæ¯ä¸ªéƒ¨åˆ†çš„å†…å®¹é€šè¿‡ä¸€ä¸ªè¾¹ç•Œï¼ˆboundaryï¼‰åˆ†éš”å¼€æ¥ã€‚boundary æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ ‡è®°ç¬¦ï¼Œç¡®ä¿æ¯ä¸ªå­—æ®µçš„è¾¹ç•Œå’Œå†…å®¹æ˜¯ç‹¬ç«‹çš„ã€‚

### è¯·æ±‚æ ¼å¼
åœ¨ `multipart/form-data` è¯·æ±‚ä¸­ï¼Œæ•°æ®æŒ‰ä»¥ä¸‹æ ¼å¼åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼ˆæ¯éƒ¨åˆ†å‰åéƒ½æœ‰è¾¹ç•Œæ ‡è¯†ç¬¦ï¼‰ï¼š

- æ¯éƒ¨åˆ†çš„ Content-Disposition è¡¨ç¤ºè¯¥éƒ¨åˆ†çš„å†…å®¹ï¼ˆå­—æ®µåæˆ–æ–‡ä»¶åï¼‰ã€‚
- å¦‚æœæ˜¯æ–‡ä»¶éƒ¨åˆ†ï¼ŒContent-Type è¡¨ç¤ºæ–‡ä»¶çš„ MIME ç±»å‹ã€‚
- æ¯éƒ¨åˆ†ä¹‹é—´ç”¨ä¸€ä¸ªå”¯ä¸€çš„ boundary è¿›è¡Œåˆ†éš”ã€‚

### ç¤ºä¾‹ HTTP è¯·æ±‚ï¼ˆè¯·æ±‚ä½“ï¼‰
å‡è®¾æˆ‘ä»¬è¦æäº¤ä¸€ä¸ªæ–‡ä»¶å’Œä¸€ä¸ªæ–‡æœ¬å­—æ®µï¼Œè¡¨å•æ•°æ®å¯èƒ½å¦‚ä¸‹ï¼š
```http request
POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Length: 475

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="username"

john_doe
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file1"; filename="example.txt"
Content-Type: text/plain

[æ–‡ä»¶å†…å®¹]
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

---
### #ä½¿ç”¨`@MultiData` + `@MultiFile`æ¥è¿›è¡Œå‚æ•°è®¾ç½®

- `@MultiData`: ç”¨äºæ ‡è¯†ä¸€ä¸ªæ–‡æœ¬å‚æ•°
- `@MultiFile`: ç”¨æ¥æ ‡è¯†ä¸€ä¸ªæ–‡ä»¶å‚æ•° 

`@MultiFile`æ³¨è§£æ”¯æŒçš„å‚æ•°ç±»å‹å¦‚ä¸‹ï¼š  
1. **è‡ªå¸¦æ–‡ä»¶åç§°å±æ€§çš„å‚æ•°ç±»å‹ï¼Œä½¿ç”¨è¿™äº›ç±»å‹æ—¶è®¾ç½®`fileName`æ˜¯æ— æ•ˆçš„**  
- `File`ã€`File[]`ã€`Collection<File>`
- `Resource`ã€`Resource[]`ã€`Collection<Resource>`
- `MultipartFile`ã€`MultipartFile[]`ã€`Collection<MultipartFile>`
- `HttpFile`ã€`HttpFile[]`ã€`Collection<HttpFile>`
- `String`ã€`String[]`ã€`Collection<String>`ç±»å‹çš„èµ„æºå®šä½ç¬¦å·ï¼Œå‚ç…§`ResourceLoader#getResource(String)`  
  ä¾‹å¦‚ï¼š
  - http://www.baidu.com/img/bd_logo1.png
  - binary:D:/test/test.txt
  - classpath:binary/*.pdf
  
2. **ä¸è‡ªå¸¦æ–‡ä»¶åå±æ€§çš„å‚æ•°ç±»å‹ï¼Œä½¿ç”¨è¿™äº›ç±»å‹æ—¶å¿…é¡»æä¾›`fileName`å±æ€§**

> ä½¿ç”¨`@MultiFile`çš„`fileName`å±æ€§è¿›è¡Œè®¾ç½®
- `byte[]`ä»¥åŠä»–çš„`æ•°ç»„`
- `Byte[]`ä»¥åŠä»–çš„`æ•°ç»„`å’Œ`é›†åˆç±»å‹`
- `InputStream`ä»¥åŠä»–çš„`æ•°ç»„`å’Œ`é›†åˆç±»å‹`  
æ³¨:

> ä½¿ç”¨`Map`ä¼ å‚ï¼Œåˆ©ç”¨`key`æ¥è®¾ç½®æ–‡ä»¶å
- `Map<String, Byte[]>`ã€`Map<String, Byte[][]>`ã€`Map<String, Collection<Byte[]>>`
- `Map<String, InputStream>`ã€`Map<String, InputStream[]>`ã€`Map<String, Collection<InputStream>>`
  
> åœ¨ä½¿ç”¨ä»¥ä¸Šç±»å‹çš„ `æ•°ç»„`æˆ–è€…`é›†åˆ`æ—¶`fileName`å±æ€§ä¸­å¯ä»¥ä½¿ç”¨å ä½ç¬¦`{_index_}`ï¼Œ  
å®é™…ç”Ÿæˆçš„æ–‡ä»¶åä¸­ä¼šè¢«æ›¿æ¢ä¸ºæ•°ç»„æˆ–è€…é›†åˆçš„ä¸‹æ ‡ã€‚  


å…·ä½“ä½¿ç”¨çš„å®ä¾‹ä»£ç å¦‚ä¸‹ï¼š  

1. ã€çº¯æ–‡æœ¬çš„è¡¨å•ã€‘

```java
/*
    ã€çº¯æ–‡æœ¬çš„è¡¨å•ã€‘
    text("Jack", 18, "jack@gmail.com")  
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="name"
    Content-Type: text/plain

    Jack
    --LuckyBoundary
    Content-Disposition: form-data; name="age"
    Content-Type: text/plain

    18
    --LuckyBoundary
    Content-Disposition: form-data; name="email"
    Content-Type: text/plain

    jack@gmail.com
    --LuckyBoundary--
      
 */
@Post("http://localhost:8080/multipartFormData")
String text(@MultiData String name, @MultiData Integer age, @MultiData String email);

// ä¸Šè¿°æ¥å£çš„ç®€åŒ–å†™æ³•
@MultiData
@Post("http://localhost:8080/multipartFormData")
String text(String name, Integer age, String email, @NotHttpParam String notMultiDataParam);
```
---
### è‡ªå¸¦`fileName`å±æ€§çš„æ–‡ä»¶å‚æ•°

1ã€`File`ã€`File[]`ã€`Collection<File>`ç±»å‹çš„æ–‡ä»¶è¡¨å•ã€‘

```java
/*
    ã€Fileæ–‡ä»¶å‚æ•°ã€‘
    // æ„å»ºæ–‡æœ¬å‚æ•°Map
    Map<String, Object> txtForm = new LinkedHashMap<>();
    txtForm.put("name", "Lucy");
    txtForm.put("sex", "å¥³");
    txtForm.put("age", "18");
    
    // æ„å»ºæ–‡ä»¶å‚æ•°
    File binary = new File("/Users/fukang/Pictures/1234.jpg")
    binary(txtForm, binary);
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_301)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="name"
    Content-Type: text/plain

    Lucy
    --LuckyBoundary
    Content-Disposition: form-data; name="sex"
    Content-Type: text/plain

    å¥³
    --LuckyBoundary
    Content-Disposition: form-data; name="age"
    Content-Type: text/plain

    18
    --LuckyBoundary
    Content-Disposition: form-data; name="binary"; filename="1234.jpg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/1234.jpg
    --LuckyBoundary--
    
 */
@Post("http://localhost:8080/multipartFormData")
String binary(@MultiData Map<String, Object> txtForm, @MultiFile File binary);

/*
    ã€File[]æ–‡ä»¶å‚æ•°ã€‘
    // æ„å»ºæ–‡æœ¬å‚æ•°Map
    Map<String, Object> txtForm = new LinkedHashMap<>();
    txtForm.put("name", "Tom");
    txtForm.put("sex", "ç”·");
    txtForm.put("age", "28");
    
    // æ„å»ºæ–‡ä»¶å‚æ•°
    File[] files = {
        new File("/Users/fukang/Pictures/1234.jpg"),
        new File("/Users/fukang/Pictures/avatar.jpg"),
        new File("/Users/fukang/Pictures/R-C.jpeg"),
    };

    luckyApi.fileArray(txtForm, files);  
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_301)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="name"
    Content-Type: text/plain

    Tom
    --LuckyBoundary
    Content-Disposition: form-data; name="sex"
    Content-Type: text/plain

    ç”·
    --LuckyBoundary
    Content-Disposition: form-data; name="age"
    Content-Type: text/plain

    28
    --LuckyBoundary
    Content-Disposition: form-data; name="files"; filename="1234.jpg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/1234.jpg
    --LuckyBoundary
    Content-Disposition: form-data; name="files"; filename="avatar.jpg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/avatar.jpg
    --LuckyBoundary
    Content-Disposition: form-data; name="files"; filename="R-C.jpeg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/R-C.jpeg
    --LuckyBoundary--
    
 */
@Post("http://localhost:8080/multipartFormData")
String fileArray(@MultiData Map<String, Object> txtForm, @MultiFile File[] files);

/*
    ã€List<File>æ–‡ä»¶å‚æ•°ã€‘
    Map<String, Object> txtForm = new LinkedHashMap<>();
    txtForm.put("name", "Tom");
    txtForm.put("sex", "ç”·");
    txtForm.put("age", "28");

    // æ„å»ºæ–‡ä»¶å‚æ•°
    List<File> fileList = Arrays.asList(
        new File("/Users/fukang/Pictures/1234.jpg"),
        new File("/Users/fukang/Pictures/avatar.jpg"),
        new File("/Users/fukang/Pictures/R-C.jpeg")
    );

    luckyApi.fileList(txtForm, fileList);
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_301)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="name"
    Content-Type: text/plain

    Tom
    --LuckyBoundary
    Content-Disposition: form-data; name="sex"
    Content-Type: text/plain

    ç”·
    --LuckyBoundary
    Content-Disposition: form-data; name="age"
    Content-Type: text/plain

    28
    --LuckyBoundary
    Content-Disposition: form-data; name="fileList"; filename="1234.jpg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/1234.jpg
    --LuckyBoundary
    Content-Disposition: form-data; name="fileList"; filename="avatar.jpg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/avatar.jpg
    --LuckyBoundary
    Content-Disposition: form-data; name="fileList"; filename="R-C.jpeg"
    Content-Type: image/jpeg

    < /Users/fukang/Pictures/R-C.jpeg
    --LuckyBoundary--    
 */
@Post("http://localhost:8080/multipartFormData")
String fileList(@MultiData Map<String, Object> txtForm, @MultiFile List<File> fileList);
```

2. ã€`Resource`ã€`MultipartFile`ã€`HttpFile`ç³»åˆ—çš„è¡¨å•ã€‘  

   `Resource`ã€`MultipartFile`ã€`HttpFile`ç³»åˆ—çš„è¡¨å•å‚æ•°å‚ç…§`File`ç±»å‹æ¥å®ç°ï¼Œæ­¤å¤„ä¸åœ¨èµ˜è¿°ã€‚


3. ã€`String`ã€`String[]`ã€`Collection<String>`ç±»å‹çš„æ–‡ä»¶è¡¨å•ã€‘

```java
/*
    // ä¸Šä¼ çš„æ–‡ä»¶ä¸ºclasspathä¸‹çš„image/123.jpg
    strResource("classpath:/image/123.jpg");
    
    // ä¸Šä¼ çš„æ–‡ä»¶ä¸ºç³»ç»Ÿè·¯å¾„ä¸‹çš„/home/image/123.jpg
    strResource("binary:/home/image/123.jpg")
    
    // ä¸Šä¼ çš„æ–‡ä»¶ä¸ºç½‘ç»œä¸Šçš„èµ„æºæ–‡ä»¶http://localhost:8080/image/123.jpg
    strResource("http://localhost:8080/image/123.jpg")
    
    // ä¸Šä¼ çš„æ–‡ä»¶ä¸ºclasspathä¸‹çš„æ‰€æœ‰.jpgæ–‡ä»¶
    strResource("classpath:/image/*.jpg");
 */
@Post("http://localhost:8080/multipartFormData")
String strResource(@MultiFile String resource);

@Post("http://localhost:8080/multipartFormData")
String strResources(@MultiFile String[] resources);

@Post("http://localhost:8080/multipartFormData")
String strResourceList(@MultiFile List<String> resourceList);
```

---
### ä¸å¸¦`fileName`å±æ€§çš„æ–‡ä»¶å‚æ•°
ç”±äºä»¥ä¸‹å‚æ•°ç±»å‹çš„æ–‡ä»¶å‚æ•°æœ¬èº«ä¸ä¼šæºå¸¦`fileName`å±æ€§ï¼Œæ‰€ä»¥éœ€è¦å¼ºåˆ¶æ‰‹åŠ¨è®¾ç½®`@MultiFile`æ³¨è§£çš„`fileName`å±æ€§ï¼Œå¦åˆ™å°†ä¼šä¸Šä¼ å¤±è´¥ã€‚

1. ã€`byte[]`ã€`byte[][]`ã€`Map<String, Byte[]>`ã€‘

```java
/*
    String string = "Lucky Hello World!";
    luckyApi.byteFile(string.getBytes());    
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_301)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="bytes"; filename="test.txt"
    Content-Type: text/plain

    < [byte[]] test.txt
    --LuckyBoundary--
 */
@Post("http://localhost:8080/multipartFormData")
String byteFile(@MultiFile(fileName = "test.txt") byte[] bytes);

/*
    ä½¿ç”¨SpELè¡¨è¾¾å¼æ¥æŒ‡å®šæ–‡ä»¶åï¼Œä»å‚æ•°åˆ—è¡¨ä¸­å–æ–‡ä»¶å
    String string = "Lucky Hello World!";
    luckyApi.byteFile(string.getBytes(), "lucky.txt");     
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_432)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="bytes"; filename="lucky.txt"
    Content-Type: text/plain

    < [byte[]] lucky.txt
    --LuckyBoundary--
 */
@Post("http://localhost:8080/multipartFormData")
String byteFile(@MultiFile(fileName= "#{fileName}") byte[] bytes, String fileName);

/*
    // {_index_}ä¸ºå ä½ç¬¦ï¼Œè¿è¡Œæ—¶ä¼šæ›¿æ¢æˆæ•°ç»„ä¸­å¯¹åº”å…ƒç´ çš„ä¸‹æ ‡
    byte[][] bytesArray= new byte[2][];
    bytesArray[0] = FileCopyUtils.copyToByteArray(new File("//Users/fukang/Pictures/avatar.jpg"));
    bytesArray[1] = FileCopyUtils.copyToByteArray(new File("/Users/fukang/Pictures/1234.jpg"));
    luckyApi.byteFiles(bytesArray);

    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_301)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="bytes"; filename="test-0.jpg"
    Content-Type: image/jpeg

    < [byte[]] test-0.jpg
    --LuckyBoundary
    Content-Disposition: form-data; name="bytes"; filename="test-1.jpg"
    Content-Type: image/jpeg

    < [byte[]] test-1.jpg
    --LuckyBoundary--    
 */
@Post("http://localhost:8080/multipartFormData")
String byteFiles(@MultiFile(fileName = "test-{_index_}.txt") byte[][] bytes);

/*

    Map<String, Byte[]> byteMap = new LinkedHashMap<>();
    byteMap.put("text.txt", new Byte[]{'t', 'e', 's', 't'});
    byteMap.put("1234.jpg", toByteObjectArray(FileCopyUtils.copyToByteArray(new File("/Users/fukang/Pictures/1234.jpg"))) );
    luckyApi.byteMap(byteMap);
    
    -->
    
    POST http://localhost:8080/multipartFormData
    User-Agent: Lucky-HttpClient/3.0.1 (Java/1.8.0_301)
    Content-Type: multipart/form-data; boundary=LuckyBoundary

    --LuckyBoundary
    Content-Disposition: form-data; name="byteMap"; filename="text.txt"
    Content-Type: text/plain

    < [byte[]] text.txt
    --LuckyBoundary
    Content-Disposition: form-data; name="byteMap"; filename="1234.jpg"
    Content-Type: image/jpeg

    < [byte[]] 1234.jpg
    --LuckyBoundary--    
 */
@Post("http://localhost:8080/multipartFormData")
String byteMap(@MultiFile Map<String, Byte[]> byteMap);
```
2. ã€`InputStream`ã€`InputStream[]`ã€`Map<String, InputStream>`ã€‘

```java
@Post("http://localhost:8080/multipartFormData")
String inputStream(@MultiFile(fileName = "test.txt") InputStream in);

@Post("http://localhost:8080/multipartFormData")
String inputStreamName(@MultiFile(fileName= "#{fileName}") InputStream in, String fileName);

@Post("http://localhost:8080/multipartFormData")
String inputStreamArray(@MultiFile(fileName = "test-{_index_}.jpg") InputStream[] ins);

@Post("http://localhost:8080/multipartFormData")
String inputStreamMap(@MultiFile Map<String, InputStream> inMap);
```
