## ğŸ¦‰ Httpæ¥å£æ–¹æ³•é»˜è®¤æ”¯æŒçš„è¿”å›å€¼ç±»å‹

è¦çŸ¥é“é€šè¿‡`HTTPæ‰§è¡Œå™¨`è¿”å›çš„å§‹ç»ˆæ˜¯`Response`å¯¹è±¡ï¼Œä½†æ˜¯HTTPä»£ç†æ¥å£æ”¯æŒçš„è¿”å›å€¼ç±»å‹æ˜¯å¤šç§å¤šæ ·çš„ï¼Œè¿™ä¸¤è€…ä¹‹é—´æ˜¯å¦‚ä½•è½¬æ¢çš„å‘¢ï¼Ÿ
æœ¬ç« èŠ‚ä¼šå¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œæ¢è®¨ã€‚
---

### # æºç è§£æ
è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå…¶å®å¾ˆç®€å•ï¼Œåœ¨æºç [HttpClientProxyObjectFactory$HttpRequestProxy#executeRequest()](../../../src/main/java/com/luckyframework/httpclient/proxy/HttpClientProxyObjectFactory.java)ä¸­å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°è½¬æ¢é€»è¾‘
å…¶ä¸­çš„æ ¸å¿ƒä»£ç å¦‚å›¾æ‰€ç¤ºï¼š

![response-convert.png](../../image/response-convert.png)

---
### # åˆ†æè¯´æ˜

åœ¨ä¸Šé¢çš„`æºç è§£æ`éƒ¨åˆ†ä¸­å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œè´Ÿè´£å“åº”ç»“æœè½¬æ¢çš„æœ‰ä¸¤å¥—API

1. é€šè¿‡[Response](../../../src/main/java/com/luckyframework/httpclient/core/meta/Response.java)å¯¹è±¡çš„`getEntity()`æ–¹æ³•è¿›è¡Œç»“æœè½¬æ¢ã€‚
2. é€šè¿‡[ResponseConvert](../../../src/main/java/com/luckyframework/httpclient/proxy/convert/ResponseConvert.java)æ¥å£çš„`convert()`æ–¹æ³•è¿›è¡Œè½¬æ¢

å…·ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š  
![rc-lct.png](../../image/rc-lct.png)

---

### # é»˜è®¤æƒ…å†µä¸‹æ¥å£æ”¯æŒçš„è¿”å›å€¼ç±»å‹åˆ†æ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå“åº”è½¬æ¢å·¥ä½œæ˜¯ç”±`Response#getEntity()`æ¥å®ç°çš„ï¼Œä»¥ä¸‹æ˜¯è¯¥æ–¹æ³•çš„æºç 
```java
/**
     * è‡ªåŠ¨å°†å“åº”çš„æ•°æ®è½¬åŒ–ä¸ºå®ä½“ç±»
     * <pre>
     *     1.ç‰¹å®šç±»å‹çš„å›ºå®šè¿”å›é€»è¾‘
     *       {@link Void} {@link Void void}                     ->   <b>null</b>
     *       {@link Response}                                   ->   <b>this</b>
     *       {@link HeaderMataData} {@link ResponseMetaData}    ->   {@link #getResponseMetaData()}
     *       {@link MultipartFile}                              ->   {@link #getMultipartFile()}
     *       {@link InputStream}                                ->   {@link #getInputStream()}
     *       {@link InputStreamSource}                          ->   {@link #getInputStreamSource()}
     *       {@link byte[]} {@link ByteArrayInputStream}        ->   {@link #getResult()}
     *       {@link String}                                     ->   {@link #getStringResult()}
     *    2.ä½¿ç”¨æ³¨å†Œçš„{@link AutoConvert}è¿›è¡Œè½¬æ¢
     *    3.æ ¹æ®<b>Content-Type</b>è¿›è¡Œè‡ªåŠ¨ç±»å‹è½¬æ¢
     *       <b>application/json</b>                            ->   {@link #jsonStrToEntity(Class)}
     *       <b>application/xml</b>                             ->   {@link #xmlStrToEntity(Type)}
     *       <b>application/x-java-serialized-object</b>        ->   {@link #javaObject()}
     *   å¦‚æœæ— æ³•è½¬åŒ–æˆ–è€…è½¬åŒ–å¤±è´¥ä¼šæ—¶æŠ›å‡ºä¸€ä¸ª{@link SerializationException}å¼‚å¸¸
     * </pre>
     *
     * @param type å®ä½“çš„æ³›å‹
     * @param <T>  ç±»å‹
     * @return typeç±»å‹çš„å®ä½“å¯¹è±¡
     */
    @SuppressWarnings("unchecked")
    default <T> T getEntity(Type type) {

        // voidç±»å‹
        if (void.class == type || Void.class == type) {
            return null;
        }
        // Responseç±»å‹
        if (Response.class == type) {
            return (T) this;
        }
        // å…ƒæ•°æ®
        if (HeaderMataData.class == type || ResponseMetaData.class == type) {
            return (T) this.getResponseMetaData();
        }
        // æ–‡ä»¶ã€æµç±»å‹çš„ç»“æœå¤„ç†
        if (MultipartFile.class == type) {
            return (T) getMultipartFile();
        }
        if (InputStream.class == type) {
            return (T) getInputStream();
        }
        if (ByteArrayInputStream.class == type) {
            return (T) new ByteArrayInputStream(getResult());
        }
        if (InputStreamSource.class == type) {
            return (T) getInputStreamSource();
        }
        if (byte[].class == type) {
            return (T) getResult();
        }

        if (String.class == type) {
            return (T) getStringResult();
        }

        // å°è¯•ä½¿ç”¨è‡ªåŠ¨è½¬æ¢å™¨è¿›è¡Œè½¬æ¢
        for (AutoConvert autoConvert : autoConvertList) {
            if (autoConvert.can(this, type)) {
                return autoConvert.convert(this, type);
            }
        }

        // Jsonã€Xmlã€Javaç±»å‹è½¬æ¢
        try {
            if (isJsonType()) {
                return jsonStrToEntity(type);
            }
            if (isXmlType()) {
                return xmlStrToEntity(type);
            }
            if (isJavaType()) {
                return (T) javaObject();
            }
            throw new SerializationException("The response result the auto-conversion is abnormal: No converter found that can handle 'Content-Type[" + getContentType() + "]'.");
        } catch (Exception e) {
            throw new SerializationException(e);
        }
    }
```

åˆ†ææºç å¯çŸ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹HTTPæ¥å£æ”¯æŒçš„è¿”å›å€¼ç±»å‹æœ‰ï¼š

- `void`/`Void` -> å›ºå®šè¿”å›å€¼ä¸º`null`
- `Response` -> å›ºå®šè¿”å›å½“å‰Responseå¯¹è±¡
- `HeaderMataData`/`ResponseMetaData` -> å›ºå®šè¿”å›å½“å‰å“åº”çš„å…ƒæ•°æ®
- `MultipartFile` -> å›ºå®šè¿”å›`MultipartFile`å¯¹è±¡ï¼Œé€‚ç”¨äºæ–‡ä»¶ä¸‹è½½åœºæ™¯
- `InputStream` -> å›ºå®šè¿”å›å½“å‰å“åº”ä½“å¯¹åº”çš„è¾“å…¥æµå¯¹è±¡
- `InputStreamSource` -> å›ºå®šè¿”å›å½“å‰å“åº”ä½“å¯¹åº”çš„è¾“å…¥æµå·¥å‚å¯¹è±¡
- `ByteArrayInputStream` -> å›ºå®šè¿”å›å½“å‰å“åº”ä½“çš„å­—èŠ‚æµå¯¹è±¡
- `byte[]` -> å›ºå®šè¿”å›å½“å‰å“åº”ä½“å†…å®¹å¯¹åº”çš„å­—èŠ‚æ•°ç»„
- `String` -> å›ºå®šè¿”å›å½“å‰å“åº”ä½“çš„å†…å®¹çš„å­—ç¬¦ä¸²æ ¼å¼
- ç”±`AutoConvert`æ”¯æŒçš„å“åº”ç±»å‹
- `application/json`ã€`application/xml`ã€`application/x-java-serialized-object` -> è¿™ä¸‰ç§æ ¼å¼çš„å“åº”ä½“ä¼šåˆ†åˆ«ä½¿ç”¨`Jackson`ã€`JAXB`ã€`ObjectInputStream`è¿›è¡Œååºåˆ—åŒ–ï¼Œç›®æ ‡ç±»å‹ä¸ºæ¥å£çš„è¿”å›å€¼ç±»å‹
- ä»¥ä¸Šç±»å‹çš„`Optional`åŒ…è£…ç±»å‹
- ä»¥ä¸Šç±»å‹çš„`Future`åŒ…è£…ç±»å‹

```java
import com.luckyframework.httpclient.core.meta.HeaderMataData;
import com.luckyframework.httpclient.core.meta.Response;
import com.luckyframework.httpclient.core.meta.ResponseMetaData;
import com.luckyframework.httpclient.proxy.annotations.DomainName;
import com.luckyframework.httpclient.proxy.annotations.Get;
import com.luckyframework.io.MultipartFile;
import org.springframework.core.io.InputStreamSource;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.util.Optional;
import java.util.concurrent.Future;

@DomainName("http://localhost:8864/convert")
public interface ConvertApi {

    // æ”¯æŒvoid/Voidä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    void voidMethod();

    // æ”¯æŒResponseä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    Response resp();

    // æ”¯æŒHeaderMataDataä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    HeaderMataData headerMeta();

    // æ”¯æŒResponseMetaDataä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    ResponseMetaData respMeta();

    // æ”¯æŒbyte[]ä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    byte[] bytes();

    // æ”¯æŒInputStreamä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    InputStream inStream();

    // æ”¯æŒByteArrayInputStreamä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    ByteArrayInputStream byteStream();

    // æ”¯æŒInputStreamSourceä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    InputStreamSource inStreamSource();

    // æ”¯æŒMultipartFileä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    MultipartFile multiFile();

    // æ”¯æŒStringä½œä¸ºè¿”å›å€¼
    @Get("respTo")
    String str();

    // å¦‚æœå“åº”ç±»å‹ä¸ºapplication/jsonï¼Œä½¿ç”¨Jacksonå°†Jsonæ ¼å¼çš„å“åº”ä½“å†…å®¹è½¬åŒ–ä¸ºResult<User>ç±»å‹
    @Get("respTo")
    Result<User> jsonAutoConvert();

    // å¦‚æœå“åº”ç±»å‹ä¸ºapplication/xmlï¼Œä½¿ç”¨JAXBå°†Xmlæ ¼å¼çš„å“åº”ä½“å†…å®¹è½¬åŒ–ä¸ºResult<User>ç±»å‹
    @Get("respTo")
    Result<User> xmlAutoConvert();

    // å¦‚æœå“åº”ç±»å‹ä¸ºapplication/x-java-serialized-objectï¼Œä½¿ç”¨ObjectInputStreamå°†å“åº”ä½“å†…å®¹ååºåˆ—åŒ–ä¸ºMap<String, Object>å¯¹è±¡
    @Get("respTo")
    Map<String, Object> jdkAutoConvert();

    // æ”¯æŒä»¥ä¸Šç±»å‹çš„OptionalåŒ…è£…ç±»å‹
    @Get("respTo")
    Optional<String> optionalStr();

    // æ”¯æŒä»¥ä¸Šç±»å‹çš„FutureåŒ…è£…ç±»ç±»å‹
    @Get("respTo")
    Future<InputStream> futureInStream();
}
```
