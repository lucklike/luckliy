## ğŸ¦„ æ³¨è§£è½¬æ¢å™¨[ï¼ˆResponseConvertï¼‰](../../../src/main/java/com/luckyframework/httpclient/proxy/convert/ResponseConvert.java)

`ResponseConvert`
ä¸ºæ³¨è§£è½¬æ¢å™¨ï¼Œå®ƒçš„æ³¨å†Œä¾èµ–äº[@ResultConvertMeta](../../../src/main/java/com/luckyframework/httpclient/proxy/annotations/ResultConvertMeta.java)
æ³¨è§£ï¼Œç›¸å¯¹é€šç”¨è½¬æ¢å™¨`Response.AutoConvert`æ¥è¯´ï¼Œæ³¨è§£è½¬æ¢å™¨çš„ä¼˜`å…ˆçº§åˆ«æ›´é«˜`ã€`æ§åˆ¶åŠ›åº¦æ›´ç»†`ï¼Œæ‰€ä»¥æ›´åŠ é€‚åˆä¸€äº›ç‰¹æ®Šçš„è½¬æ¢éœ€æ±‚ã€‚

---

### # æ¥å£ä»‹ç»

**æ³¨è§£è½¬æ¢å™¨æ¥å£**ï¼š`ResponseConvert`  
è¯¥æ¥å£ä¸»è¦è´Ÿè´£æ•°æ®è½¬æ¢ä¸å¤„ç†ç›¸å…³çš„é€»è¾‘
```java

@FunctionalInterface
public interface ResponseConvert {

    /**
     * å°†ç›¸åº”å®ä½“è½¬åŒ–ä¸ºæŒ‡å®šç±»å‹çš„å®ä½“
     *
     * @param response å“åº”å®ä½“
     * @param context  è½¬åŒ–å™¨æ³¨è§£ä¸Šä¸‹æ–‡
     * @param <T>      è¿”å›å®ä½“ç±»å‹
     * @return è¿”å›å®ä½“
     * @throws Exception è½¬æ¢å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸
     */
    <T> T convert(Response response, ConvertContext context) throws Throwable;
}
```

**ç”¨äºæ³¨å†Œæ³¨è§£è½¬æ¢å™¨çš„å…ƒæ³¨è§£**`@ResultConvertMeta`  
è¯¥æ³¨è§£ç”¨äºæ³¨å†Œæ³¨è§£è½¬æ¢å™¨ï¼Œä½¿å…¶ç”Ÿæ•ˆ
```java
@Target({ElementType.METHOD, ElementType.TYPE, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@ConvertMetaType
public @interface ResultConvertMeta {

    /**
     * å“åº”ç»“æœè½¬æ¢å™¨ç”Ÿæˆå™¨ï¼Œç”¨äºç”Ÿæˆ{@link ResponseConvert}å¯¹è±¡çš„ç”Ÿæˆå™¨
     */
    ObjectGenerate convert();

    /**
     * è½¬æ¢å…ƒç±»å‹
     */
    @AliasFor(annotation = ConvertMetaType.class, attribute = "value")
    Class<?> metaType() default Object.class;

}

```

---

### # å·²å®ç°çš„æ³¨è§£è½¬æ¢å™¨

| å®ç°ç±»                                                                                                                                                                                                                                                  | è¯´æ˜                                        |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
| [@RespConvert](../../../src/main/java/com/luckyframework/httpclient/proxy/annotations/RespConvert.java)  +  [ResultSelectionResponseConvert](../../../src/main/java/com/luckyframework/httpclient/proxy/convert/ResultSelectionResponseConvert.java) | æä¾›åŸºäº`SpELè¡¨è¾¾å¼`å®ç°çš„å“åº”æ•°æ®`ç­›é€‰`ã€`è¿‡æ»¤`ã€`å¤„ç†`ã€`æ•´åˆ`åŠŸèƒ½ |
| [@DownloadToLocal](../../../src/main/java/com/luckyframework/httpclient/proxy/annotations/DownloadToLocal.java) + [FileDownloadResultConvert](../../../src/main/java/com/luckyframework/httpclient/proxy/convert/FileDownloadResultConvert.java)     | å®ç°æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ç£ç›˜çš„åŠŸèƒ½                            |
| [@SseResultConvert](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/SseResultConvert.java) + [SseResponseConvert](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/SseResponseConvert.java)                             | å®ç°SSEå“åº”ç»“æœå¤„ç†çš„åŸºæœ¬åŠŸèƒ½                          |

 #### `@RespConvert`**ä½¿ç”¨è¯´æ˜** ï¼š

1. **æ•°æ®å®šä½åŠŸèƒ½**  

```java
@DomainName("http://localhost:8864/user/")
public interface RespConvertApi {

    // #{$body$.data} ï¼šåªè·å–å“åº”ä½“'data'éƒ¨åˆ†çš„æ•°æ®è¿›è¡Œè½¬æ¢
    @Mock(mockFunc = "userList")
    @RespConvert("#{$body$.data}")
    @Get("/user/list")
    List<User> getUsers();

    //----------------------------------------------------------
    //                      Mock method
    //----------------------------------------------------------


    static MockResponse userList() {
        User user1 = new User();
        user1.setId(1);
        user1.setName("User-1");
        user1.setEmail("User-1@qq.com");
        user1.setAge(18);

        User user2 = new User();
        user2.setId(2);
        user2.setName("User-2");
        user2.setEmail("User-2@qq.com");
        user2.setAge(17);

        User user3 = new User();
        user3.setId(3);
        user3.setName("User-3");
        user3.setEmail("User-3@qq.com");
        user3.setAge(16);

        User user4 = new User();
        user4.setId(4);
        user4.setName("User-4");
        user4.setEmail("User-4@qq.com");
        user4.setAge(21);

        List<User> users = Arrays.asList(user1, user2, user3, user4);
        return MockResponse.create().status(200).json(Result.success(users));
    }
}
```

å•å…ƒæµ‹è¯•ç»“æœï¼š  

![resp-convert-users.png](../../image/resp-convert-users.png)

2. **æ•°æ®ç­›é€‰åŠŸèƒ½**

    ç­›é€‰å‡ºå¹´é¾„å¤§äºç­‰äº18å²çš„æ‰€æœ‰ç”¨æˆ·
```java
@DomainName("http://localhost:8864/user/")
public interface RespConvertApi {

    // #{$body$.data.?[#this.age >= 18]} ï¼šç­›é€‰å‡ºç”¨æˆ·åˆ—è¡¨ä¸­å¹´é¾„å¤§äºç­‰äº18å²çš„ç”¨æˆ·
    @Mock(mockFunc = "userList")
    @RespConvert("#{$body$.data.?[#this.age >= 18]}")
    @Get("/user/list")
    List<User> getAdultUsers();

    //--------------------Mock Methodå¿½ç•¥----------------------------//
}
```
å•å…ƒæµ‹è¯•ç»“æœï¼š  
![resp-convert-filter.png](../../image/resp-convert-filter.png)

3. **æ•°æ®æŠ•å½±åŠŸèƒ½**

    è·å–æ‰€æœ‰ç”¨æˆ·çš„IDä¿¡æ¯ï¼Œå…¶ä»–ä¿¡æ¯å¿½ç•¥

```java
@DomainName("http://localhost:8864/user/")
public interface RespConvertApi {

    // #{$body$.data.![#this.id]} ï¼šè·å–æ‰€æœ‰ç”¨æˆ·çš„IDä¿¡æ¯ç»„æˆé›†åˆï¼Œå…¶ä»–ä¿¡æ¯å¿½ç•¥
    @Mock(mockFunc = "userList")
    @RespConvert("#{$body$.data.![#this.id]}")
    @Get("/user/list")
    List<Integer> getAllUseId();

    //--------------------Mock Methodå¿½ç•¥----------------------------//
}
```
å•å…ƒæµ‹è¯•ç»“æœï¼š  
![resp-convert-ids.png](../../image/resp-convert-ids.png)

4. **è‡ªå®šä¹‰æ•°æ®å¤„ç†**  
å°†æŸ¥è¯¢å‡ºçš„æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­

```java
@DomainName("http://localhost:8864/user/")
public interface RespConvertApi {

    // #{$this$.saveToDB(@userMapper, $body$.data)} -> å°†æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“
    @Mock(mockFunc = "userList")
    @RespConvert("#{$this$.saveToDB(@userMapper, $body$.data)}")
    @Get("/user/list")
    void queryAndSaveToDB();

    // å°†ç”¨æˆ·ä¿¡æ¯å†™å…¥æ•°æ®åº“
    default saveToDB(UserMapper userMapper, Collection<User> users) {
        if (ContainerUtils.isNotEmptyCollection(users)) {
            userMapper.insertOrUpdate(users);
        }
    }

    //--------------------Mock Methodå¿½ç•¥----------------------------//
}
```

---
### # è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£è½¬æ¢å™¨

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç±»ä¼¼äº` @RespConvert`æ³¨è§£åŠŸèƒ½çš„æ³¨è§£è½¬æ¢å™¨æ¥ç†Ÿæ‚‰å¼€å‘ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£è½¬æ¢å™¨çš„ä¸»è¦æµç¨‹ã€‚

**è½¬æ¢é€»è¾‘**ï¼š
1. æŒ‡å®šä½¿ç”¨`Google Gson`æ¥ä½œä¸ºJSONååºåˆ—åŒ–å·¥å…·ï¼Œå¹¶å°†ååºåˆ—åŒ–åçš„ç»“æœä¿å­˜åˆ°`Rootä¸Šä¸‹æ–‡å˜é‡$gdata$`ä¸­
2. æ”¯æŒä½¿ç”¨`SpELè¡¨è¾¾å¼`æ¥è¿›è¡Œæ•°æ®è½¬æ¢

**å¼€å‘æµç¨‹**ï¼š

1. å®šä¹‰ä¸€ä¸ªç”¨äºå®ç°ä»¥ä¸Šè½¬æ¢é€»è¾‘çš„æ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`
2. å®šä¹‰ä¸€ä¸ªç”¨äºæ³¨å†Œè¯¥æ³¨è§£è½¬æ¢å™¨çš„æ³¨è§£`@GsonDecoder`
3. ä½¿ç”¨`@ResultConvertMeta`æ³¨è§£ç»‘å®šæ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`

å…·ä½“ä»£ç ï¼š

> #`@GsonDecoder`æ³¨è§£æºç 

```java
import com.luckyframework.httpclient.proxy.annotations.ObjectGenerate;
import com.luckyframework.httpclient.proxy.annotations.ResultConvertMeta;
import com.luckyframework.reflect.Combination;
import org.springframework.core.annotation.AliasFor;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Inherited;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target({ElementType.METHOD, ElementType.TYPE, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@Combination({ResultConvertMeta.class})
@ResultConvertMeta(convert = @ObjectGenerate(GsonResponseConvert.class))
public @interface GsonDecoder {

    /**
     * åŒ select
     */
    @AliasFor("select")
    String value() default "";

    /**
     * ç»“æœé€‰æ‹©è¡¨è¾¾å¼ï¼Œæ”¯æŒSpELè¡¨è¾¾å¼
     */
    @AliasFor("value")
    String select() default "";
    
    /**
     * è½¬æ¢å…ƒç±»å‹
     */
    @AliasFor(annotation = ResultConvertMeta.class, attribute = "metaType")
    Class<?> metaType() default Object.class;
}
```

æ³¨è§£è¯´æ˜ï¼š

- `select`/`value` : ç»“æœé€‰æ‹©è¡¨è¾¾å¼ï¼Œæ”¯æŒSpELè¡¨è¾¾å¼ï¼Œé…ç½®ä¹‹åå°†è¿”å›è¯¥è¡¨è¾¾å¼çš„ç»“æœ
- å¦‚ä¸‹ä»£ç ç”¨äºç»‘å®šæ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`

```java
@Combination({ResultConvertMeta.class})
@ResultConvertMeta(convert = @ObjectGenerate(GsonResponseConvert.class))
```

> #`GsonResponseConvert`ç±»æºç 

```java
import com.alibaba.nacos.shaded.com.google.gson.Gson;
import com.luckyframework.common.StringUtils;
import com.luckyframework.httpclient.core.meta.Response;
import com.luckyframework.httpclient.proxy.convert.ConvertContext;
import com.luckyframework.httpclient.proxy.convert.ResponseConvert;
import com.luckyframework.spel.LazyValue;

import java.lang.reflect.Type;

public class GsonResponseConvert implements ResponseConvert {

    private final Gson gson = new Gson();

    @Override
    public <T> T convert(Response response, ConvertContext context) throws Throwable {
        // è·å–GsonDecoderæ³¨è§£å®ä¾‹ï¼Œå¹¶è·å–ç”¨äºå¤„ç†ç»“æœçš„SpELè¡¨è¾¾å¼select
        GsonDecoder gsonDecoderAnn = context.toAnnotation(GsonDecoder.class);
        String select = gsonDecoderAnn.select();

        Type methodReturnType = context.getRealMethodReturnType();
        if (StringUtils.hasText(select)) {
            // è·å–è½¬æ¢å…ƒç±»å‹
            Class<?> convertMetaType = context.getConvertMetaType();
            // å‘ä¸Šä¸‹æ–‡å˜é‡ä¸­æ·»åŠ ä¸€ä¸ªRootå˜é‡$gdata$
            context.getContextVar().addRootVariable("$gdata$", LazyValue.of(() -> gson.fromJson(response.getStringResult(), convertMetaType)));
            // è¿è¡Œç»“æœé€‰æ‹©è¡¨è¾¾å¼ï¼Œè¿”å›ç»“æœ
            return context.parseExpression(select, methodReturnType);
        } 
        // ä¸å­˜åœ¨è¡¨è¾¾å¼çš„æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨Gsonå°†è½¬åŒ–ä¸ºæ–¹æ³•è¿”å›å€¼ç±»å‹å®ä¾‹å¹¶è¿”å›
        else {
            return gson.fromJson(response.getStringResult(), methodReturnType);
        }
    }
}

```

- ç»™æ¥å£æ ‡æ³¨ä¸Š`@GsonDecoder`æ³¨è§£ï¼Œåº”ç”¨æ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`åŠŸèƒ½

```java

@DomainName("http://localhost:8864")
public interface AnnConvertApi {
    
    /*
      #{$gdata$.data.^[#this.id eq #root.uid]} : æ ¹æ®ä¼ å…¥çš„uidè¿›è¡Œç­›é€‰ï¼Œè¿”å›æ»¡è¶³è¦æ±‚çš„ç¬¬ä¸€ä¸ªå…ƒç´    
     */
   @Mock(mockFunc = "userList")
   @GsonDecoder("#{$gdata$.data.^[#this.id eq #root.uid]}")
   @Get("/user/list")
   User gsonDecoderFindById(Integer uid);

   //--------------------Mock Methodå¿½ç•¥----------------------------//
}
```

è¿è¡Œç»“æœï¼š  
![gson-select.png](../../image/gson-select.png)

---


