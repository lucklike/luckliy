## ğŸ¦„ æ³¨è§£è½¬æ¢å™¨[ï¼ˆResponseConvertï¼‰](../../../src/main/java/com/luckyframework/httpclient/proxy/convert/ResponseConvert.java)

`ResponseConvert`ä¸ºæ³¨è§£è½¬æ¢å™¨ï¼Œå®ƒçš„æ³¨å†Œä¾èµ–äº[@ResultConvertMeta](../../../src/main/java/com/luckyframework/httpclient/proxy/annotations/ResultConvertMeta.java)æ³¨è§£ï¼Œç›¸å¯¹é€šç”¨è½¬æ¢å™¨`Response.AutoConvert`æ¥è¯´ï¼Œæ³¨è§£è½¬æ¢å™¨
çš„ä¼˜`å…ˆçº§åˆ«æ›´é«˜`ã€`æ§åˆ¶åŠ›åº¦æ›´ç»†`ï¼Œæ‰€ä»¥æ›´åŠ é€‚åˆä¸€äº›ç‰¹æ®Šçš„è½¬æ¢éœ€æ±‚ã€‚

---

### # æ¥å£ä»‹ç»
```java
@FunctionalInterface
public interface ResponseConvert {

    /**
     * å°†ç›¸åº”å®ä½“è½¬åŒ–ä¸ºæŒ‡å®šç±»å‹çš„å®ä½“
     *
     * @param response å“åº”å®ä½“
     * @param context  è½¬åŒ–å™¨æ³¨è§£ä¸Šä¸‹æ–‡
     * @param <T>      è¿”å›å®ä½“ç±»å‹
     * @return è¿”å›å®ä½“
     * @throws Exception è½¬æ¢å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸
     */
    <T> T convert(Response response, ConvertContext context) throws Throwable;
}
```
---

### # æ³¨å†Œæ³¨è§£è½¬æ¢å™¨
æ³¨å†Œ`æ³¨è§£è½¬æ¢å™¨`éœ€è¦å€ŸåŠ©[@ResultConvertMeta](../../../src/main/java/com/luckyframework/httpclient/proxy/annotations/ResultConvertMeta.java)æ³¨è§£æ¥å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªæ¡ˆä¾‹æ¥åŠ ä»¥è¯´æ˜ï¼š

ç°åœ¨éœ€è¦å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„è½¬æ¢å™¨ï¼š
1. æŒ‡å®š`Json`ååºåˆ—åŒ–æ–¹æ¡ˆä¸º`Google GSON`
2. æ”¯æŒè‡ªå®šä¹‰æ—¶é—´å­—æ®µçš„ååºåˆ—åŒ–æ ¼å¼
3. æ”¯æŒä½¿ç”¨`SpELè¡¨è¾¾å¼`æ¥è½¬æ¢å“åº”ç»“æœ

å¼€å‘æµç¨‹ï¼š  
1. å®šä¹‰ä¸€ä¸ªç”¨äºå®ç°ä»¥ä¸Šè½¬æ¢é€»è¾‘çš„æ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`
2. å®šä¹‰ä¸€ä¸ªç”¨äºæ³¨å†Œè¯¥æ³¨è§£è½¬æ¢å™¨çš„æ³¨è§£`@GsonDecoder`

å…·ä½“ä»£ç ï¼š  

> #`@GsonDecoder`æ³¨è§£æºç 
```java
import com.luckyframework.httpclient.proxy.annotations.ObjectGenerate;
import com.luckyframework.httpclient.proxy.annotations.ResultConvertMeta;
import com.luckyframework.reflect.Combination;
import org.springframework.core.annotation.AliasFor;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Inherited;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target({ElementType.METHOD, ElementType.TYPE, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@Combination({ResultConvertMeta.class})
@ResultConvertMeta(convert = @ObjectGenerate(GsonResponseConvert.class))
public @interface GsonDecoder {

    /**
     * åŒ select
     */
    @AliasFor("select")
    String value() default "";

    /**
     * ç»“æœé€‰æ‹©è¡¨è¾¾å¼ï¼Œæ”¯æŒSpELè¡¨è¾¾å¼
     */
    @AliasFor("value")
    String select() default "";

    /**
     * æ—¶é—´æ ¼å¼
     */
    String dateFormat() default "yyyy-MM-dd HH:mm:ss";

    /**
     * è½¬æ¢å…ƒç±»å‹
     */
    @AliasFor(annotation = ResultConvertMeta.class, attribute = "metaType")
    Class<?> metaType() default Object.class;
}
```
æ³¨è§£è¯´æ˜ï¼š  
- `select`/`value` : ç»“æœé€‰æ‹©è¡¨è¾¾å¼ï¼Œæ”¯æŒSpELè¡¨è¾¾å¼ï¼Œé…ç½®ä¹‹åå°†è¿”å›è¯¥è¡¨è¾¾å¼çš„ç»“æœ
- `dateFormat`ï¼šå¦‚æœå­˜åœ¨æ—¶é—´å­—æ®µï¼Œä½¿ç”¨è¯¥æ ¼å¼è¿›è¡Œè½¬æ¢  
- å¦‚ä¸‹ä»£ç ç”¨äºæ³¨å†Œæ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`
```java
@Combination({ResultConvertMeta.class})
@ResultConvertMeta(convert = @ObjectGenerate(GsonResponseConvert.class))
```

> #`GsonResponseConvert`ç±»æºç 

```java
import com.alibaba.nacos.shaded.com.google.gson.Gson;
import com.alibaba.nacos.shaded.com.google.gson.GsonBuilder;
import com.luckyframework.common.StringUtils;
import com.luckyframework.httpclient.core.meta.Response;
import com.luckyframework.httpclient.proxy.convert.ConvertContext;
import com.luckyframework.httpclient.proxy.convert.ResponseConvert;
import com.luckyframework.spel.LazyValue;

import java.lang.reflect.Type;

public class GsonResponseConvert implements ResponseConvert {

    private final GsonBuilder gsonBuilder = new GsonBuilder();

    @Override
    public <T> T convert(Response response, ConvertContext context) throws Throwable {
        // è·å–GsonDecoderæ³¨è§£å®ä¾‹
        GsonDecoder gsonDecoderAnn = context.toAnnotation(GsonDecoder.class);

        // è®¾ç½®æ—¶é—´æ ¼å¼ï¼Œå¹¶åˆ›å»ºGsonå®ä¾‹
        String dateFormat = gsonDecoderAnn.dateFormat();
        if (StringUtils.hasText(dateFormat)) {
            gsonBuilder.setDateFormat(dateFormat);
        }
        Gson gson = gsonBuilder.create();

        Type methodReturnType = context.getRealMethodReturnType();
        String select = gsonDecoderAnn.select();
        if (StringUtils.hasText(select)) {
            // è·å–è½¬æ¢å…ƒç±»å‹
            Class<?> convertMetaType = context.getConvertMetaType();
            // å‘ä¸Šä¸‹æ–‡å˜é‡ä¸­æ·»åŠ ä¸€ä¸ªRootå˜é‡$gdata$
            context.getContextVar().addRootVariable("$gdata$", LazyValue.of(() -> gson.fromJson(response.getStringResult(),convertMetaType)));
            // è¿è¡Œç»“æœé€‰æ‹©è¡¨è¾¾å¼ï¼Œè¿”å›ç»“æœ
            return context.parseExpression(select, methodReturnType);
        } else {
            return gson.fromJson(response.getStringResult(), methodReturnType);
        }
    }
}

```

> #ç»™æ¥å£æ ‡æ³¨ä¸Š`@GsonDecoder`æ³¨è§£ï¼Œåº”ç”¨æ³¨è§£è½¬æ¢å™¨`GsonResponseConvert`åŠŸèƒ½

```java
@DomainName("http://localhost:8864")
public interface AnnConvertApi {

    @Mock
    @GsonDecoder("#{$gdata$.data.email}")
    @Get("/user/get/#{uid}")
    String getUserEmail(Integer uid);

    static MockResponse getUserEmail$Mock(@Param("#{uid}") Integer uid) {
        User user = new User();
        user.setId(uid);
        user.setName("User-" + uid);
        user.setEmail(StringUtils.format("{}@qq.com", user.getName()));
        user.setPhone("17455678790");
        return MockResponse.create().status(200).json(Result.success(user));
    }
}
```

è¿è¡Œç»“æœï¼š  
![gson-select.png](../../image/gson-select.png)