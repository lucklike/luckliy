## ğŸ½ SSE

SSEï¼ˆServer-Sent Eventsï¼‰æ˜¯ä¸€ç§é€šè¿‡HTTPåè®®ä»æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å•å‘æ¨é€å®æ—¶æ•°æ®çš„æŠ€æœ¯ã€‚å®ƒå…è®¸æœåŠ¡å™¨åœ¨æœ‰æ–°æ•°æ®æ—¶ä¸»åŠ¨å°†æ›´æ–°æ¨é€åˆ°å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯è®©å®¢æˆ·ç«¯å®šæœŸå‘å‡ºè¯·æ±‚ã€‚

**SSEçš„ç‰¹ç‚¹ï¼š**

1. **å•å‘é€šä¿¡**ï¼šæ•°æ®ä»æœåŠ¡å™¨æµå‘å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ— æ³•å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚HTTPè¯·æ±‚ï¼‰ä¸æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚
2. **åŸºäºHTTP**ï¼šSSEä½¿ç”¨æ ‡å‡†çš„HTTPåè®®ï¼Œå› æ­¤æ— éœ€é¢å¤–çš„åè®®æˆ–åº“ã€‚å®ƒæ˜¯ç”±æµè§ˆå™¨æ”¯æŒçš„ã€‚
3. **å®æ—¶æ¨é€**ï¼šé€‚ç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚æ–°é—»æ¨é€ã€å®æ—¶æ›´æ–°ç­‰ã€‚
4. **æ–‡æœ¬æ•°æ®æµ**ï¼šSSEä¼ è¾“çš„æ˜¯æ–‡æœ¬æ ¼å¼çš„æ•°æ®ï¼Œå¸¸è§çš„å¦‚JSONã€XMLç­‰æ ¼å¼ã€‚

**`SSE`ä¸`WebSocket`çš„å¯¹æ¯”ï¼š**

- **SSE**ï¼šå•å‘é€šä¿¡ã€åŸºäºHTTPã€å®ç°ç®€å•ã€æµè§ˆå™¨åŸç”Ÿæ”¯æŒã€é€‚ç”¨äºä½é¢‘æ›´æ–°ã€‚
- `WebSocket`ï¼šåŒå‘é€šä¿¡ã€éœ€è¦ä¸“é—¨çš„åè®®æ”¯æŒã€é€‚ç”¨äºå®æ—¶èŠå¤©ã€å¤šäººåä½œç­‰åœºæ™¯ã€‚

æ€»çš„æ¥è¯´ï¼ŒSSEé€‚ç”¨äºéœ€è¦ä»æœåŠ¡å™¨å•å‘æ¨é€å®æ—¶æ›´æ–°çš„åº”ç”¨ï¼Œå¦‚è‚¡ç¥¨ä»·æ ¼æ›´æ–°ã€å®æ—¶é€šçŸ¥ç­‰ï¼Œè€ŒWebSocketåˆ™é€‚ç”¨äºéœ€è¦åŒå‘å®æ—¶é€šä¿¡çš„åœºæ™¯ã€‚

---

### åœ¨`Lucky`ä¸­è°ƒç”¨`SSE`æ¥å£çš„åŸºæœ¬æ­¥éª¤

1. å°†åœ¨`SSEæ¥å£`ä¸Šä½¿ç”¨`@Sse`æ³¨è§£è¿›è¡Œæ ‡æ³¨
2. äº‹ä»¶ç›‘å¬å™¨[EventListener](../../../src/main/java/com/luckyframework/httpclient/proxy/sse/EventListener.java)
   ï¼Œè¯¥ç›‘å¬å™¨ç”¨æ¥ç›‘å¬æœåŠ¡å™¨çš„æ•°æ®å“åº”å¹¶è§¦å‘ç›¸åº”çš„å›è°ƒæ–¹æ³•
3. `SSEæ¥å£`ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆ`EventListener`ï¼‰
    - é€šè¿‡`@Sse`çš„`listener`/`listenerClass`/`expression`å±æ€§æ¥ç»‘å®šç›‘å¬å™¨
    - é€šè¿‡æ¥å£å‚æ•°æ¥ä¼ é€’äº‹ä»¶ç›‘å¬å™¨ï¼ˆè¯¥æ–¹å¼çš„ä¼˜å…ˆçº§æœ€é«˜ï¼‰


- `@Sse`æ³¨è§£å±æ€§è¯´æ˜

| æ³¨è§£å±æ€§                                       | è¯´æ˜                                                                                                                                                                                                                                                                                | æ˜¯å¦æ”¯æŒ`SpEL`è¡¨è¾¾å¼ |
|--------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|
| `async`                                    | `å¼‚æ­¥å¼€å…³`ï¼Œé»˜è®¤å…³é—­                                                                                                                                                                                                                                                                       | âŒ             |
| `executor`                                 | **æŒ‡å®šå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œå™¨**<br/>1.å¦‚æœè¡¨è¾¾å¼ç»“æœç±»å‹ä¸º`Executor`æ—¶ç›´æ¥ä½¿ç”¨è¯¥æ‰§è¡Œå™¨<br/> 2. å¦‚æœè¡¨è¾¾å¼ç»“æœç±»å‹ä¸º`ThreadPoolParam`æ—¶ï¼Œä½¿ç”¨`ThreadPoolFactory#createThreadPool(ThreadPoolParam)`æ¥åˆ›å»ºæ‰§è¡Œå™¨ <br/>3.å¦‚æœè¡¨è¾¾å¼ç»“æœç±»å‹ä¸º`String`æ—¶ï¼Œä½¿ç”¨`HttpClientProxyObjectFactory#getAlternativeAsyncExecutor(String)`æ¥è·å–æ‰§è¡Œå™¨ <br/> 4.è¿”å›ç»“æœä¸ºå…¶ä»–ç±»å‹æ—¶å°†æŠ¥é”™ | âœ…             |
| `concurrency`                              | æœ€å¤§å¹¶å‘æ•°ï¼Œé…ç½®ä¹‹å`lucky`ä¼šä¸ºå½“å‰æ–¹æ³•åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„çº¿ç¨‹æ± (ä½¿ç”¨`Executors#newFixedThreadPool(int)`åˆ›å»º)ï¼Œæ­¤é…ç½®çš„ä¼˜å…ˆçº§ä½äº `executor`                                                                                                                                                                                   | âœ…             |
| `listener`/`listenerClass`/`expression`    | ç”¨äºç»‘å®šä¸€ä¸ªæµå¼æ•°æ®ç›‘å¬å™¨ï¼ˆEventListenerï¼‰å®ä¾‹ <br/>  `listener`: é€šè¿‡`@ObjectGenerate`æ¥è¿›è¡Œé…ç½®<br/> `listenerClass` : é…ä½¿ç”¨`Class<? EventListener>`æ–¹å¼æ¥é…ç½® <br/> `expression`: é€šè¿‡`SpEL`è¡¨è¾¾å¼æ¥è¿”å›ä¸€ä¸ª`EventListener`å®ä¾‹å¯¹è±¡                                                                                        | âœ…             |
| `connectionTimeout`/`connectionTimeoutExp` | è¿æ¥è¶…æ—¶æ—¶é—´ <br/> `connectionTimeout`: `int`ç±»å‹é…ç½®ï¼Œ`å•ä½ï¼šms ` <br/> `connectionTimeoutExp`: `String`ç±»å‹é…ç½®ï¼Œæ”¯æŒ`SpEL`è¡¨è¾¾å¼ï¼Œ`å•ä½ï¼šms `                                                                                                                                                              | âœ…             |
| `readTimeout`/`readTimeoutExp`             | è¯»å–è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ï¼š`10min `<br/> `readTimeout`: `int`ç±»å‹é…ç½®ï¼Œ`å•ä½ï¼šms ` <br/> `readTimeoutExp`: `String`ç±»å‹é…ç½®ï¼Œæ”¯æŒ`SpEL`è¡¨è¾¾å¼ï¼Œ`å•ä½ï¼šms `                                                                                                                                                              | âœ…             |
| `writeTimeout`/`writeTimeoutExp`           | å†™è¶…æ—¶æ—¶é—´ <br/> `writeTimeout`: `int`ç±»å‹é…ç½®ï¼Œ`å•ä½ï¼šms ` <br/> `writeTimeoutExp`: `String`ç±»å‹é…ç½®ï¼Œæ”¯æŒ`SpEL`è¡¨è¾¾å¼ï¼Œ`å•ä½ï¼šms `                                                                                                                                                                         | âœ…             |

- `EventListener`äº‹ä»¶æ–¹æ³•è¯´

| äº‹ä»¶æ–¹æ³•                                   | è¯´æ˜           |
|----------------------------------------|--------------|
| `void onOpen(Event<Response> event)`   | å½“è¿æ¥å»ºç«‹æ—¶è§¦å‘     |
| `void onText(Event<String> event) `    | æ¥æ”¶åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯æ—¶è§¦å‘ |
| `void onError(Event<Throwable> event)` | å½“å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘     |
| `void onClose(Event<Void> event)`      | å½“è¿æ¥å…³é—­æ—¶è§¦å‘     |

---

### # ç¤ºä¾‹ä»£ç 

ä»¥`DeepSeek`å®˜ç½‘æä¾›çš„[å¯¹è¯APIä¸º](https://api-docs.deepseek.com/zh-cn/)ä¾‹æ¥è¿›è¡Œè¯´æ˜ï¼š
![deepseek.png](../../image/deepseek.png)

1. å®ç°ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨`DeepSeekEventListener`

```java
public class DeepSeekEventListener implements EventListener {

   @Override
   public void onOpen(Event<Response> event) throws Throwable {
      System.out.println("è¿æ¥å·²å»ºç«‹ï¼");
   }

   @Override
   public void onText(Event<String> event) throws Exception {
      System.out.println("æ¥æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯ï¼š" + event.getMessage());
   }

   @Override
   public void onError(Event<Throwable> event) {
      System.out.println("å‘ç”Ÿå¼‚å¸¸: " + event.getMessage().getMessage());
   }

   @Override
   public void onClose(Event<Void> event) {
      System.out.println("è¿æ¥å·²å…³é—­");
   }
}

```

2. å£°æ˜SSEæ¥å£å¹¶ç»‘å®šä¸Šé¢å®ç°çš„äº‹ä»¶ç›‘å¬å™¨`DeepSeekEventListener`

  ä¸ºäº†æ–¹ä¾¿ä¼ å‚åœ¨`classpath`ä¸‹æ„å»ºä¸€ä¸ªåä¸º`deepseek-param.json`çš„jsonæ–‡ä»¶ç”¨äºå‚æ•°è¯»å–ã€‚  

 ` classpath: deepseek-param.json`ï¼Œå…¶ä¸­`"content": "#{content}"`è¡¨ç¤º`content`æ¥è‡ªå‚æ•°åˆ—è¡¨çš„åç§°ä¸º`content`å‚æ•°
```json
 {
   "stream": true,
   "model": "deepseek-chat",
   "messages": [
      {
         "role": "system",
         "content": "You are a helpful assistant."
      },
      {
         "role": "user",
         "content": "#{content}"
      }
   ]
}
```

å®šä¹‰`DeepSeek`å¯¹è¯æ¥å£

```java
@DomainName("${DeepSeek.url}")
public interface DeepSeekApi {

   /*
      é€šè¿‡@Sseæ³¨è§£çš„listenerClassæ¥ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ŒDeepSeekEventListenerä¸ºå•åˆ©æ¨¡å¼åˆ›å»º
    */
   @Sse(listenerClass = DeepSeekEventListener.class)
   @StaticJsonBody("``#{#read(#resource('classpath:deepseek-param.json'))}``")
   @StaticHeader("Authorization: Bearer ${DeepSeek.apiKey}")
   @Post("/chat/completions")
   void completions(String content);


   /*
      é€šè¿‡@Sseæ³¨è§£çš„listeneræ¥ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œscope = Scope.PROTOTYPE è¡¨ç¤ºDeepSeekEventListenerçš„åˆ›å»ºæ¨¡å¼ä¸ºå¤šä¾‹ï¼Œå³æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å®ä¾‹   
    */
   @Sse(listener = @ObjectGenerate(clazz = DeepSeekEventListener.class, scope = Scope.PROTOTYPE))
   @StaticJsonBody("``#{#read(#resource('classpath:deepseek-param.json'))}``")
   @StaticHeader("Authorization: Bearer ${DeepSeek.apiKey}")
   @Post("/chat/completions")
   void completions2(String content);


   /*
      é€šè¿‡å‚æ•°æ¥ä¼ é€’äº‹ä»¶ç›‘å¬å™¨     
    */
   @Sse
   @StaticJsonBody("``#{#read(#resource('classpath:deepseek-param.json'))}``")
   @StaticHeader("Authorization: Bearer ${DeepSeek.apiKey}")
   @Post("/chat/completions")
   void completions3(String content, DeepSeekEventListener listener);
}
```

ç¼–å†™å•å…ƒæµ‹è¯•ç±»
```java
@SpringBootTest
class DeepSeekApiTest {

    @Resource
    private  DeepSeekApi api;

    @Test
    void completions() {
        api.completions("ä½ å¥½å‘€");
    }

    @Test
    void completions2() {
        api.completions2("ä½ å¥½å‘€");
    }

    @Test
    void completions3() {
        api.completions3("ä½ å¥½å‘€", new DeepSeekEventListener());
    }
}
```

æœ€ç»ˆçš„æ‰§è¡Œæ—¥å¿—ï¼š

è¯·æ±‚ï¼š  
![deepseek-req.png](../../image/deepseek-req.png)

å“åº”ï¼š  
![deepseek-resp.png](../../image/deepseek-resp.png)

---
### æ‰©å±•
å¦‚æœä½ æ˜¯ä¸€ä¸ªæœ‰è¿½æ±‚çš„å¼€å‘è€…ï¼Œé‚£ä½ ä¸€å®šå¾ˆä¸å–œæ¬¢ä¸Šé¢æ¥å£ä¸Šæ ‡æ³¨çš„ä¸€å¤§å †æ³¨è§£å§ï¼å˜¿å˜¿ï¼Œè¿™ä¸å·§äº†å—ï¼Œæˆ‘ä¹Ÿä¸å–œæ¬¢ï¼Œé‡åˆ°è¿™ç§æƒ…å†µæˆ‘ä¸ªäººæ›´åŠ å€¾å‘äºå°†ä¸Šé¢ä¸€å¤§å †æ³¨è§£
å…¨éƒ¨é€šè¿‡[ç»„åˆæ³¨è§£çš„æœºåˆ¶]()å°è£…åˆ°ä¸€ä¸ªæ³¨è§£ä¸­

å°è£…ä¸€ä¸ªç»„åˆæ³¨è§£`@DeepSeekChat`
```java
/*
     ç»„åˆæ³¨è§£ï¼Œç›¸å½“äº@Sse + @StaticJsonBody + @StaticHeader
 */
@Target({ElementType.METHOD, ElementType.TYPE, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@Sse
@StaticJsonBody("")
@StaticHeader("Authorization: Bearer ${DeepSeek.apiKey}")
public @interface DeepSeekChat {

    @AliasFor(annotation = StaticJsonBody.class, attribute = "value")
    String param() default "``#{#read(#resource('classpath:deepseek-param.json'))}``";

    @AliasFor(annotation = Sse.class, attribute = "listenerClass")
    Class<? extends EventListener> listenerClass() default DeepSeekEventListener.class;
}

```

ä½¿ç”¨`@DeepSeekChat`æ³¨è§£æ”¹é€ ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œè¿™ä¸‹æ¸…çˆ½å¤šäº†ï¼Œå“ˆå“ˆå“ˆå“ˆï¼ï¼
```java
@DomainName("${DeepSeek.url}")
public interface DeepSeekApi {

   /*
      é€šè¿‡@Sseæ³¨è§£çš„listenerClassæ¥ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ŒDeepSeekEventListenerä¸ºå•åˆ©æ¨¡å¼åˆ›å»º
    */
   @DeepSeekChat
   @Post("/chat/completions")
   void completions(String content);

   /*
      é€šè¿‡å‚æ•°æ¥ä¼ é€’äº‹ä»¶ç›‘å¬å™¨     
    */
   @DeepSeekChat
   @Post("/chat/completions")
   void completions3(String content, DeepSeekEventListener listener);
}
```

