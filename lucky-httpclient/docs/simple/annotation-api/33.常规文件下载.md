## â¬‡ï¸ æ™®é€šæ–‡ä»¶ä¸‹è½½

---

### # `å†…å­˜`/`æµå¼`æ¨¡å¼ä¸‹è½½

æ™®é€šæ–‡ä»¶ä¸‹è½½ä¸éœ€è¦è¿›è¡Œä»»ä½•é…ç½®ï¼Œåªéœ€è¦å°†æ¥å£è¿”å›å€¼è®¾ç½®ä¸ºæŒ‡å®šçš„ç±»å‹å³å¯

| è¿”å›å€¼ç±»å‹                                             | æ³¨æ„äº‹é¡¹                                |
|---------------------------------------------------|-------------------------------------|
| `byte[]`                                          | æ–‡ä»¶æ•°æ®å°†å…¨éƒ¨ä¿å­˜åœ¨`å†…å­˜`ä¸­ï¼Œé€‚ç”¨äºå°æ–‡ä»¶ä¸‹è½½            |
| `ByteArrayInputStream`                            | æ–‡ä»¶æ•°æ®å°†å…¨éƒ¨ä¿å­˜åœ¨`å†…å­˜`ä¸­ï¼Œé€‚ç”¨äºå°æ–‡ä»¶ä¸‹è½½            |
| `InputStream`                                     | `æµå¼æ•°æ®`ï¼Œé€‚åˆå¤§æ–‡ä»¶ä¸‹è½½ï¼Œæµä½¿ç”¨å®Œæ¯•ä¹‹åéœ€è¦æ‰‹åŠ¨å…³é—­        |
| `InputStreamSource`                               | `æµå¼æ•°æ®`ï¼Œé€‚åˆå¤§æ–‡ä»¶ä¸‹è½½ï¼Œæµä½¿ç”¨å®Œæ¯•ä¹‹åéœ€è¦æ‰‹åŠ¨å…³é—­        |
| `com.luckyframework.io.MultipartFile`             | `æµå¼æ•°æ®`ï¼Œæä¾›äº†æ›´å¤šæ–¹ä¾¿çš„APIï¼ˆåæ–‡ä¸­ä¼šè¯¦ç»†ä»‹ç»ï¼‰ï¼Œæ¨èä½¿ç”¨ğŸ‘ |
| `org.springframework.web.multipart.MultipartFile` | `æµå¼æ•°æ®`ï¼Œåªèƒ½åœ¨`Spring`ç¯å¢ƒä¸­ä½¿ç”¨             |

- **ç¤ºä¾‹ä»£ç **

```java

@DomainName("http://localhost:8864/")
public interface DownloadApi {

    /*
        ä½¿ç”¨byte[]ä½œä¸ºè¿”å›å€¼ï¼Œæ­¤æ–¹å¼åªé€‚ç”¨äºå°æ–‡ä»¶ä¸‹è½½ï¼Œè¶…å¤§æ–‡ä»¶ä½¿ç”¨æ­¤æ–¹æ³•å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
     */
    @Get("/download/image.png")
    byte[] downloadForBytes();

    /*
        ä½¿ç”¨byte[]ä½œä¸ºè¿”å›å€¼ï¼Œæ­¤æ–¹å¼åªé€‚ç”¨äºå°æ–‡ä»¶ä¸‹è½½ï¼Œè¶…å¤§æ–‡ä»¶ä½¿ç”¨æ­¤æ–¹æ³•å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
    */
    @Get("/download/image.png")
    ByteArrayInputStream downloadForByteInStream();


    /*
        ä½¿ç”¨InputStreamä½œä¸ºè¿”å›å€¼ï¼Œæµå¼æ•°æ®ï¼Œå¯ä»¥å¤„ç†ä¸€äº›è¶…å¤§æ–‡ä»¶ï¼Œä½¿ç”¨å®Œæ¯•ä¹‹åè¯·åŠ¡å¿…æ‰‹åŠ¨å…³é—­æµ    
     */
    @Get("/download/ideaIU-2024.3.dmg")
    InputStream downloadForInputStream();

    /*
        ä½¿ç”¨InputStreamSourceä½œä¸ºè¿”å›å€¼ï¼Œæµå¼æ•°æ®ï¼Œå¯ä»¥å¤„ç†ä¸€äº›è¶…å¤§æ–‡ä»¶ï¼Œä½¿ç”¨å®Œæ¯•ä¹‹åè¯·åŠ¡å¿…æ‰‹åŠ¨å…³é—­æµ    
    */
    @Get("/download/ideaIU-2024.3.dmg")
    InputStreamSource downloadForInputStreamSource();

    /*
        æ³¨ï¼šæ­¤ç±»å‹åªèƒ½åœ¨spring-webç¯å¢ƒä¸­ä½¿ç”¨
        ä½¿ç”¨Springæä¾›çš„MultipartFileä½œä¸ºè¿”å›å€¼ï¼Œæµå¼æ•°æ®ï¼Œå…·ä½“APIè¯·å‚ç…§Springæä¾›çš„æ–‡æ¡£
     */
    @Get("/download/ideaIU-2024.3.dmg")
    org.springframework.web.multipart.MultipartFile downloadForSpringMF();


    /*
        ä½¿ç”¨Luckyæä¾›çš„MultipartFileä½œä¸ºè¿”å›å€¼ï¼Œæµå¼æ•°æ®ï¼Œè¯¥ç±»æä¾›äº†ä¸°å¯Œçš„æ–‡ä»¶æ“ä½œAPIï¼Œå¤§å°æ–‡ä»¶å‡é€‚ç”¨ï¼Œæ¨èä½¿ç”¨è¯¥è¿”å›å€¼
     */
    @Get("/download/ideaIU-2024.3.dmg")
    com.luckyframework.io.MultipartFile downloadForLuckyFM();
}
```

- `com.luckyframework.io.MultipartFile`APIä»‹ç»

| æ–¹æ³•                                                      | æè¿°                                                            |
|---------------------------------------------------------|---------------------------------------------------------------|
| `String getFileType()`                                  | è·å–æ–‡ä»¶ç±»å‹ï¼Œä¸€èˆ¬ä¸ºæ–‡ä»¶çš„åç¼€åï¼Œä¾‹å¦‚ï¼š`.jpg`ã€`.log`                             |
| `String getContentType()`                               | è·å–æ–‡ä»¶å¯¹åº”çš„`content-type`ï¼Œä¾‹å¦‚ï¼š`image/jpeg`ã€`application/zip`       |
| `String getFileName()`                                  | è·å–æœ€ç»ˆçš„æ–‡ä»¶å                                                      |
| `String getOriginalFileName()`                          | è·å–åŸå§‹æ–‡ä»¶å                                                       |
| `String setFileName(String) `                           | è®¾ç½®æ–‡ä»¶å                                                         |
| `long getSize()`                                        | è·å–æ–‡ä»¶å¤§å°                                                        |
| `InputStream getInputStream() `                         | è·å–æ–‡ä»¶æ•°æ®å¯¹åº”çš„è¾“å…¥æµ                                                  |
| `byte[] getByte()  `                                    | è·å–æ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®                                                    |
| `void copyToFolder(File) `                              | å°†æ–‡ä»¶æ•°æ®æ‹·è´åˆ°æœ¬åœ°æŒ‡å®šçš„æ–‡ä»¶å¤¹ä¸­                                             |
| `void progressMonitorCopy(File, ProgressMonitor, int) ` | `è¿›åº¦ç›‘æ§æ¨¡å¼`çš„æ–‡ä»¶æ‹·è´ï¼Œ`File`ä¸ºç›®æ ‡æ–‡ä»¶å¤¹ï¼Œ`ProgressMonitor`ä¸ºè¿›åº¦ç›‘æ§å™¨ã€`int`ä¸ºå—…æ¢é¢‘ç‡ |
| `void progressBarCopy(File) `                           | `è¿›åº¦æ¡æ¨¡å¼æ‹·è´`ï¼Œæ‹·è´è¿‡ç¨‹ä¸­æ§åˆ¶å°ä¼šå®æ—¶æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯                                   |

- ä»¥`void progressMonitorCopy(File, ProgressMonitor, int) `ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼š

```java

@SpringBootTest
public class DownloadApiTest {

    @Resource
    private DownloadApi downloadApi;

    @Test
    void luckyMultipartFileTest() {
        MultipartFile mf = downloadApi.downloadForLuckyFM();

        // ä¿å­˜æ–‡ä»¶çš„ç›®å½•
        File saveFile = new File("/home/download/");
        // å—…æ¢é¢‘ç‡ï¼Œæ¯è¿›è¡Œnæ¬¡byte[]çš„å¤åˆ¶è¿›è¡Œä¸€æ¬¡å—…æ¢
        int frequency = 25;
        // æ„é€ è¿›åº¦ç›‘æ§å™¨å®ä¾‹
        ProgressMonitor progressMonitor = new ProgressMonitor() {

            @Override
            public void sniffing(Progress progress) {
                // æœ¬åœ°æ–‡ä»¶å¯¹è±¡
                File file = progress.getFile();
                // æ–‡ä»¶çš„æ€»å­—èŠ‚æ•°
                long total = progress.getTotal();
                // å·²ç»ä¸‹è½½å®Œæˆçš„å­—èŠ‚æ•°
                long complete = progress.getComplete();
                // å¹³å‡ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼š byte/sï¼‰
                double avgSpeed = progress.getAvgSpeed();
                // è·å–ä¸‹è½½å®Œæˆçš„æ¯”ä¾‹ï¼ˆ0.13ï¼‰
                double completeRate = progress.getCompleteRate();
                // å½“å‰ä¸‹è½½è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰
                long takeTime = progress.geTakeTime();
                // é¢„è®¡å‰©ä½™æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
                double remainTime = progress.getRemainTime();

                //-----------------------å…¶ä»–å¤„ç†é€»è¾‘------------------
            }

            @Override
            public void beforeBeginning(Progress progress) {
                System.out.println("æ•°æ®æ‹·è´ä¹‹å‰æ‰§è¡Œ");
            }

            @Override
            public void afterCompleted(Progress progress) {
                System.out.println("æ•°æ®æ‹·è´å®Œæˆä¹‹åæ‰§è¡Œ");
            }

            @Override
            public void afterFailed(Progress progress, Exception e) throws Exception {
                System.out.println("æ•°æ®æ‹·è´è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸æ—¶æ‰§è¡Œ");
            }
        };

        // æ‰§è¡Œæ–‡ä»¶æ‹·è´
        mf.progressMonitorCopy(saveFile, progressMonitor, frequency);
    }

}

```

----

### # `ç£ç›˜`æ¨¡å¼ä¸‹è½½

å¦‚æœä½ éœ€è¦å°†æ–‡ä»¶`ä¿å­˜åˆ°æœ¬åœ°`ä¹‹åå†æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡å¼ï¼Œè¯¥æ¨¡å¼éœ€è¦å€ŸåŠ©`@DownloadToLocal`æ³¨è§£æ¥å®ç°ã€‚

1. `@DownloadToLocal`æ³¨è§£æ”¯æŒçš„æ¥å£è¿”å›å€¼ç±»å‹å¦‚ä¸‹ï¼š

| æ”¯æŒçš„è¿”å›å€¼ç±»å‹            | è¯´æ˜                                |
|---------------------|-----------------------------------|
| `void`              | é™é»˜ä¸‹è½½                              |
| `Boolean`/`boolean` | æ˜¯å¦ä¸‹è½½æˆåŠŸ                            |
| `String`            | ä¸‹è½½åˆ°ç£ç›˜ä¸Šåæ–‡ä»¶çš„è·¯å¾„                      |
| `Long`/`long`       | ä¸‹è½½åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶çš„å¤§å°                      |
| `File`              | ä¸‹è½½åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶                         |
| `InputStream`       | ä¸‹è½½åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶æµ                        |
| `MultipartFile`     | ä¸‹è½½åˆ°ç£ç›˜ä¸Šçš„æ–‡ä»¶å¯¹åº”çš„Lucky MultipartFileå¯¹è±¡ |

2. `@DownloadToLocal`æ³¨è§£å±æ€§ä»‹ç»

| å±æ€§å                      | è¯´æ˜                                                                                 | æ˜¯å¦æ”¯æŒ`SpEL`è¡¨è¾¾å¼ |
|--------------------------|------------------------------------------------------------------------------------|---------------|
| `saveDir`/`value `       | ä¿å­˜æ–‡ä»¶çš„ä½ç½®ï¼Œå¿…é¡»æ˜¯æ–‡ä»¶å¤¹ï¼Œä¸åšé…ç½®æ—¶é»˜è®¤çš„ä¿å­˜è·¯å¾„ä¸ºï¼š `${java.io.tmpdir}/Lucky/@DownloadToLocal/yyyyMMdd/` | âœ…             |
| `filename`               | ç”¨äºè®¾ç½®æœ€ç»ˆä¿å­˜çš„æ–‡ä»¶åï¼Œæ”¯æŒå ä½ç¬¦ï¼š`{_name_}`: **åŸæ–‡ä»¶å**; `{.ext}`: **åŸæ–‡ä»¶æ‰©å±•å**                      | âœ…             |
| `useOriginalFileName`    | æ˜¯å¦ä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼Œé»˜è®¤false                                                                  | âŒ             |
| `monitor`/`monitorClass` | ç”¨äºè®¾ç½®è¿›åº¦ç›‘æ§å™¨å®ç°ç±»                                                                       | âŒ             |
| `frequency`              | ï¼ˆå­˜åœ¨è¿›åº¦ç›‘æ§å™¨æ—¶æ‰ç”Ÿæ•ˆï¼‰å—…æ¢é¢‘ç‡ï¼Œæ¯æ‹·è´çš„å­—èŠ‚æ•°ä¸º4096bï¼Œæ‹·è´næ¬¡ä¹‹åè¿›è¡Œä¸€æ¬¡å—…æ¢ï¼Œé»˜è®¤100kbå—…æ¢ä¸€æ¬¡                           | âŒ             |

3. è¢«`@DownloadToLocal`æ³¨è§£æ ‡æ³¨çš„æ¥å£å‡æ”¯æŒç‰¹æ®Šå‚æ•°ï¼š`ProgressMonitor`

å³è¿›åº¦ç›‘æ§å™¨å®ä¾‹å¯ä»¥ä½œä¸ºæ–¹æ³•å‚æ•°æ¥ä¼ é€’

- **ç¤ºä¾‹ä»£ç **

```java

@DomainName("http://localhost:8864/")
public interface DownloadToLocalApi {


    /*
        é™é»˜ä¸‹è½½
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š${java.io.tmpdir}/Lucky/@DownloadToLocal/yyyyMMdd/ 
        æœ€ç»ˆæ–‡ä»¶åï¼šé»˜è®¤æ–‡ä»¶å+æ—¶é—´ä»¥åŠéšæœºå­—ç¬¦ç»„æˆçš„æ–‡ä»¶å  
         
     */
    @DownloadToLocal
    @Get("download/#{fileName}")
    void downloadToLocal(String fileName);

    /*
        è¿”å›å€¼ä¸ºFileå¯¹è±¡
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼šD:/download/yyyyMMdd/
        æœ€ç»ˆæ–‡ä»¶åï¼šé»˜è®¤æ–‡ä»¶å+æ—¶é—´ä»¥åŠéšæœºå­—ç¬¦ç»„æˆçš„æ–‡ä»¶å    
     */
    @DownloadToLocal(saveDir = "D:/download/#{#yyyyMMddDate()}/")
    @Get("download/#{fileName}")
    File downloadToLocal2(String fileName);

    /*
        è¿”å›å€¼ä¸ºlongå¯¹è±¡
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼šç”±å‚æ•°savePathå†³å®š
        æœ€ç»ˆæ–‡ä»¶åï¼šé»˜è®¤æ–‡ä»¶å+æ—¶é—´ä»¥åŠéšæœºå­—ç¬¦ç»„æˆçš„æ–‡ä»¶å  
    */
    @DownloadToLocal(saveDir = "#{savePath}")
    @Get("download/#{fileName}")
    long downloadToLocal3(String fileName, String savePath);

    /*
        è¿”å›å€¼ä¸ºInputStreamå¯¹è±¡
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š${java.io.tmpdir}/Lucky/@DownloadToLocal/yyyyMMdd/ 
        æœ€ç»ˆæ–‡ä»¶åï¼šç”±å‚æ•°saveNameå†³å®š
    */
    @DownloadToLocal(filename = "#{saveName}")
    @Get("download/#{fileName}")
    InputStream downloadToLocal4(String fileName, String saveName);

    /*
        è¿”å›å€¼ä¸ºInputStreamå¯¹è±¡ï¼Œä½¿ç”¨æ–‡ä»¶åå ä½ç¬¦
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š${java.io.tmpdir}/Lucky/@DownloadToLocal/yyyyMMdd/ 
        æœ€ç»ˆæ–‡ä»¶åï¼šyyyyMMdd-åŸæ–‡ä»¶å-5ä½éšæœºå­—ç¬¦.åŸæ–‡ä»¶åç¼€
    */
    @DownloadToLocal(filename = "#{#yyyyMMddDate()}-{_name_}-#{#nanoid(5)}{.ext}")
    @Get("download/#{fileName}")
    InputStream downloadToLocal41(String fileName);

    /*
        è¿”å›å€¼ä¸ºbyte[]å¯¹è±¡
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼šD:/download/ 
        æœ€ç»ˆæ–‡ä»¶åï¼šåŸå§‹æ–‡ä»¶å
    */
    @DownloadToLocal(useOriginalFileName = true, saveDir = "D:/download/")
    @Get("download/#{fileName}")
    byte[] downloadToLocal5(String fileName);

    /*
        è¿”å›å€¼ä¸ºMultipartFileå¯¹è±¡
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š${java.io.tmpdir}/Lucky/@DownloadToLocal/yyyyMMdd/ 
        æœ€ç»ˆæ–‡ä»¶åï¼šé»˜è®¤æ–‡ä»¶å+æ—¶é—´ä»¥åŠéšæœºå­—ç¬¦ç»„æˆçš„æ–‡ä»¶å
        è¿›åº¦ç›‘æ§å™¨ï¼šConsolePrintProgressMonitorï¼ˆæ§åˆ¶å°æ‰“å°ä¸‹è½½è¿›åº¦ï¼‰
    */
    @DownloadToLocal(monitorClass = ConsolePrintProgressMonitor.class)
    @Get("download/#{fileName}")
    MultipartFile downloadToLocal6(String fileName);

    /*
        è¿”å›å€¼ä¸ºbooleanå¯¹è±¡
        æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š${java.io.tmpdir}/Lucky/@DownloadToLocal/yyyyMMdd/ 
        æœ€ç»ˆæ–‡ä»¶åï¼šé»˜è®¤æ–‡ä»¶å+æ—¶é—´ä»¥åŠéšæœºå­—ç¬¦ç»„æˆçš„æ–‡ä»¶å
        è¿›åº¦ç›‘æ§å™¨ï¼šè¿›åº¦ç›‘æ§é€»è¾‘ç”±å‚æ•°progressMonitorå†³å®š
    */
    @DownloadToLocal
    @Get("download/#{fileName}")
    boolean downloadToLocal7(String fileName, ProgressMonitor progressMonitor);
}

```